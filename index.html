<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Postcard</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display&family=Dancing+Script&family=Bebas+Neue&family=Courier+Prime&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
    body{font-family:-apple-system,BlinkMacSystemFont,sans-serif;background:#FFF9F5;min-height:100vh}
    .app{max-width:430px;margin:0 auto;min-height:100vh}
    .tap{cursor:pointer;transition:transform .1s}.tap:active{transform:scale(.97);opacity:.8}
    input{font-family:inherit;-webkit-user-select:text;user-select:text}
    .hidden{display:none}
    #loading{display:flex;align-items:center;justify-content:center;min-height:100vh;flex-direction:column;gap:16px}
    #loading .spinner{font-size:48px}
    #error{display:none;padding:20px;text-align:center;color:#c62828}
    #updateBanner{display:none;position:fixed;top:0;left:0;right:0;background:#4CAF50;color:#fff;padding:12px 20px;text-align:center;font-size:14px;z-index:9999;cursor:pointer}
  </style>
</head>
<body>
<div id="updateBanner" onclick="location.reload(true)">New version available! Tap to update.</div>
<div class="app">
  <div id="loading">
    <div class="spinner">üìÆ</div>
    <p style="color:#8B8680">Loading...</p>
  </div>
  <div id="error"></div>
  <div id="app"></div>
</div>

<script>
// App version - CHANGE THIS when you update the app
var APP_VERSION = '1.0.3';

// Force update check for iOS PWA
(function checkForUpdates() {
  var storedVersion = localStorage.getItem('postcard_version');
  
  console.log('Current version:', APP_VERSION, 'Stored version:', storedVersion);
  
  // If version changed, show update banner
  if (storedVersion && storedVersion !== APP_VERSION) {
    console.log('Update available!');
    document.getElementById('updateBanner').style.display = 'block';
    // Clear any caches we can
    if ('caches' in window) {
      caches.keys().then(function(names) {
        for (var i = 0; i < names.length; i++) {
          caches.delete(names[i]);
        }
      });
    }
  }
  
  // Always store current version
  localStorage.setItem('postcard_version', APP_VERSION);
  
  // For iOS: check for updates when app becomes visible
  document.addEventListener('visibilitychange', function() {
    if (document.visibilityState === 'visible') {
      fetch(window.location.href.split('?')[0] + '?_=' + Date.now(), {
        cache: 'no-store',
        headers: {'Cache-Control': 'no-cache'}
      })
        .then(function(r) { return r.text(); })
        .then(function(html) {
          var match = html.match(/APP_VERSION\s*=\s*['"]([^'"]+)['"]/);
          if (match && match[1] !== APP_VERSION) {
            console.log('New version detected:', match[1]);
            document.getElementById('updateBanner').style.display = 'block';
          }
        })
        .catch(function(e) { console.log('Update check failed:', e); });
    }
  });
})();

window.onerror = function(msg, url, line, col, error) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('error').style.display = 'block';
  document.getElementById('error').innerHTML = '<h2>‚ö†Ô∏è Error Loading App</h2><p style="margin:16px 0">This app needs to be hosted on a web server.</p><p style="font-size:12px;color:#666">If you uploaded this to a hosting service and still see this error, try refreshing the page.</p><p style="font-size:11px;margin-top:20px;color:#999">Error: ' + msg + '</p>';
  return true;
};
</script>

<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

<script>
(function() {
  // Check if Firebase loaded
  if (typeof firebase === 'undefined') {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error').style.display = 'block';
    document.getElementById('error').innerHTML = '<h2>‚ö†Ô∏è Cannot Load</h2><p style="margin:16px 0">Please upload this file to a web hosting service like Netlify, Vercel, or GitHub Pages.</p><p style="font-size:12px;color:#666">Opening HTML files directly from your computer does not work due to browser security restrictions.</p>';
    return;
  }

  document.getElementById('loading').style.display = 'none';
  
  var firebaseConfig = {
    apiKey: "AIzaSyCVCSTiYb0oj-qiWrQA6PNJw3L1LcQcN2k",
    authDomain: "postcard-d055d.firebaseapp.com",
    projectId: "postcard-d055d",
    storageBucket: "postcard-d055d.firebasestorage.app",
    messagingSenderId: "241151731606",
    appId: "1:241151731606:web:1cac2069b350b1543a1fb7"
  };
  firebase.initializeApp(firebaseConfig);
  var db = firebase.firestore();
  var auth = firebase.auth();
  var storage = firebase.storage();
  
  // Set auth persistence to LOCAL so users stay logged in
  auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(function(e) {
    console.error('Auth persistence error:', e);
  });

  var FONTS = [
    {n: 'Classic', v: '-apple-system,sans-serif'},
    {n: 'Elegant', v: 'Playfair Display,serif'},
    {n: 'Script', v: 'Dancing Script,cursive'},
    {n: 'Bold', v: 'Bebas Neue,sans-serif'},
    {n: 'Mono', v: 'Courier Prime,monospace'}
  ];
  var COLORS = ['#FFFFFF', '#2D2A26', '#E07A5F', '#81B29A', '#F2CC8F', '#3D405B'];
  var L = {bg: '#FFF9F5', card: '#FFF', text: '#2D2A26', muted: '#8B8680', border: '#E8E4DF', accent: '#E07A5F'};
  var D = {bg: '#1A1918', card: '#252422', text: '#F5F2EE', muted: '#8B8680', border: '#3D3A36', accent: '#E07A5F'};
  var t = L;

  var state = {
    view: 'auth',
    dark: false,
    user: null,
    userData: null,
    friends: [],
    friendRequests: [],
    myPosts: [],
    posted: false,
    sel: null,
    step: 1,
    np: {photo: null, outfit: null, songTitle: '', songArtist: '', loc: '', quote: '', privateNote: '', outfitX: 0, outfitY: 0, photoX: 0, photoY: 0, songFont: 0, songColor: 0},
    authMode: 'login',
    authData: {email: '', password: '', username: '', birthday: '', avatar: null},
    authError: '',
    authLoading: false,
    calDate: new Date(),
    dayPost: null,
    friendProfile: null,
    friendCalDate: new Date(),
    friendDayPost: null,
    showAddFriend: false,
    friendCode: '',
    activeEdit: null,
    showMenu: false,
    saving: false,
    savedImage: null,
    uploading: false,
    editProfile: {username: '', avatar: null, newAvatar: null},
    editingProfile: false,
    savingProfile: false
  };

  function setState(updates) {
    for (var key in updates) {
      state[key] = updates[key];
    }
    render();
  }

  function setNp(updates) {
    for (var key in updates) {
      state.np[key] = updates[key];
    }
    render();
  }

  function setAuthData(updates) {
    for (var key in updates) {
      state.authData[key] = updates[key];
    }
    render();
  }

  auth.onAuthStateChanged(function(u) {
    if (u) {
      state.user = u;
      loadUserData(u.uid);
    } else {
      setState({user: null, userData: null, view: 'auth'});
    }
  });

  function loadUserData(uid) {
    db.collection('users').doc(uid).get().then(function(doc) {
      if (doc.exists) {
        var data = doc.data();
        state.userData = {id: uid};
        for (var k in data) state.userData[k] = data[k];
        loadPosts(uid);
        loadFriends(uid);
        loadFriendRequests(uid);
        setState({view: 'feed'});
      }
    });
  }

  var postsUnsubscribe = null;
  var friendsUnsubscribe = null;
  var friendPostsUnsubscribes = [];

  function loadPosts(uid) {
    // Unsubscribe from previous listener
    if (postsUnsubscribe) {
      postsUnsubscribe();
    }
    
    // Set up real-time listener for my posts
    postsUnsubscribe = db.collection('posts')
      .where('userId', '==', uid)
      .onSnapshot(function(snap) {
        var posts = [];
        snap.forEach(function(d) {
          var p = {id: d.id};
          var data = d.data();
          for (var k in data) p[k] = data[k];
          posts.push(p);
        });
        // Sort by date descending
        posts.sort(function(a, b) {
          return b.date.localeCompare(a.date);
        });
        var today = new Date().toISOString().split('T')[0];
        var hasPosted = false;
        for (var i = 0; i < posts.length; i++) {
          if (posts[i].date === today) hasPosted = true;
        }
        setState({myPosts: posts, posted: hasPosted});
      }, function(error) {
        console.error('Posts listener error:', error);
        // Fallback to one-time fetch
        db.collection('posts').where('userId', '==', uid).get().then(function(snap) {
          var posts = [];
          snap.forEach(function(d) {
            var p = {id: d.id};
            var data = d.data();
            for (var k in data) p[k] = data[k];
            posts.push(p);
          });
          posts.sort(function(a, b) { return b.date.localeCompare(a.date); });
          var today = new Date().toISOString().split('T')[0];
          var hasPosted = posts.some(function(p) { return p.date === today; });
          setState({myPosts: posts, posted: hasPosted});
        });
      });
  }

  function loadFriends(uid) {
    // Unsubscribe from previous listeners
    if (friendsUnsubscribe) {
      friendsUnsubscribe();
    }
    friendPostsUnsubscribes.forEach(function(unsub) { unsub(); });
    friendPostsUnsubscribes = [];
    
    // Listen for changes to my user doc (for friends list changes)
    friendsUnsubscribe = db.collection('users').doc(uid).onSnapshot(function(userDoc) {
      var data = userDoc.data();
      if (!data) return;
      var ids = data.friends || [];
      
      if (ids.length === 0) {
        setState({friends: []});
        return;
      }
      
      // Clear old post listeners
      friendPostsUnsubscribes.forEach(function(unsub) { unsub(); });
      friendPostsUnsubscribes = [];
      
      var friendsData = [];
      var completed = 0;
      
      ids.forEach(function(fid) {
        db.collection('users').doc(fid).get().then(function(fDoc) {
          if (fDoc.exists) {
            var f = {id: fid};
            var fdata = fDoc.data();
            for (var k in fdata) f[k] = fdata[k];
            f.posts = [];
            
            // Set up real-time listener for this friend's posts (no orderBy to avoid index requirement)
            var unsubFriendPosts = db.collection('posts')
              .where('userId', '==', fid)
              .onSnapshot(function(pSnap) {
                f.posts = [];
                pSnap.forEach(function(d) {
                  var p = {id: d.id};
                  var pdata = d.data();
                  for (var k in pdata) p[k] = pdata[k];
                  f.posts.push(p);
                });
                // Sort by date descending
                f.posts.sort(function(a, b) { return b.date.localeCompare(a.date); });
                // Update state with new posts
                setState({friends: state.friends.slice()});
              }, function(error) {
                console.error('Friend posts listener error:', error);
                // Fallback fetch
                db.collection('posts').where('userId', '==', fid).get().then(function(pSnap) {
                  f.posts = [];
                  pSnap.forEach(function(d) {
                    var p = {id: d.id};
                    var pdata = d.data();
                    for (var k in pdata) p[k] = pdata[k];
                    f.posts.push(p);
                  });
                  f.posts.sort(function(a, b) { return b.date.localeCompare(a.date); });
                  setState({friends: state.friends.slice()});
                });
              });
            
            friendPostsUnsubscribes.push(unsubFriendPosts);
            friendsData.push(f);
            completed++;
            
            if (completed === ids.length) {
              setState({friends: friendsData});
            }
          } else {
            completed++;
            if (completed === ids.length) {
              setState({friends: friendsData});
            }
          }
        });
      });
    }, function(error) {
      console.error('Friends listener error:', error);
    });
  }

  var friendRequestsUnsubscribe = null;
  
  function loadFriendRequests(uid) {
    // Unsubscribe from previous listener if exists
    if (friendRequestsUnsubscribe) {
      friendRequestsUnsubscribe();
    }
    
    // Set up real-time listener
    friendRequestsUnsubscribe = db.collection('friendRequests')
      .where('toId', '==', uid)
      .where('status', '==', 'pending')
      .onSnapshot(function(snap) {
        var requests = [];
        var completed = 0;
        if (snap.empty) {
          setState({friendRequests: []});
          return;
        }
        snap.forEach(function(d) {
          var req = {id: d.id};
          var data = d.data();
          for (var k in data) req[k] = data[k];
          db.collection('users').doc(req.fromId).get().then(function(userDoc) {
            if (userDoc.exists) {
              req.fromUser = userDoc.data();
              req.fromUser.id = req.fromId;
            }
            requests.push(req);
            completed++;
            if (completed === snap.size) {
              setState({friendRequests: requests});
            }
          });
        });
      }, function(error) {
        console.error('Friend requests listener error:', error);
      });
  }

  function sendFriendRequest(toId) {
    if (!state.user) return;
    var fromId = state.user.uid;
    // Check if already friends
    db.collection('users').doc(fromId).get().then(function(doc) {
      var friends = doc.data().friends || [];
      if (friends.indexOf(toId) !== -1) {
        alert('Already friends!');
        return;
      }
      // Check if request already exists
      db.collection('friendRequests')
        .where('fromId', '==', fromId)
        .where('toId', '==', toId)
        .where('status', '==', 'pending')
        .get().then(function(snap) {
          if (!snap.empty) {
            alert('Friend request already sent!');
            return;
          }
          // Create request
          db.collection('friendRequests').add({
            fromId: fromId,
            toId: toId,
            status: 'pending',
            createdAt: new Date().toISOString()
          }).then(function() {
            alert('Friend request sent!');
            setState({friendCode: ''});
          });
        });
    });
  }

  function acceptFriendRequest(request) {
    var fromId = request.fromId;
    var toId = state.user.uid;
    
    // Update request status first
    db.collection('friendRequests').doc(request.id).update({status: 'accepted'}).then(function() {
      // Add friend to my list
      return db.collection('users').doc(toId).get();
    }).then(function(doc) {
      var myFriends = doc.data().friends || [];
      if (myFriends.indexOf(fromId) === -1) {
        myFriends.push(fromId);
        return db.collection('users').doc(toId).update({friends: myFriends});
      }
    }).then(function() {
      // Add me to their list
      return db.collection('users').doc(fromId).get();
    }).then(function(doc) {
      var theirFriends = doc.data().friends || [];
      if (theirFriends.indexOf(toId) === -1) {
        theirFriends.push(toId);
        return db.collection('users').doc(fromId).update({friends: theirFriends});
      }
    }).then(function() {
      // Reload everything
      loadFriendRequests(toId);
      loadFriends(toId);
    }).catch(function(e) {
      console.error('Error accepting friend request:', e);
    });
  }

  function declineFriendRequest(request) {
    db.collection('friendRequests').doc(request.id).update({status: 'declined'}).then(function() {
      loadFriendRequests(state.user.uid);
    });
  }

  function handleSignup() {
    var a = state.authData;
    if (!a.email || !a.password || !a.username || !a.birthday) {
      setState({authError: 'Please fill all fields'});
      return;
    }
    setState({authLoading: true, authError: ''});
    auth.createUserWithEmailAndPassword(a.email, a.password).then(function(cred) {
      var saveUser = function(avatarUrl) {
        var userData = {
          username: a.username,
          email: a.email,
          birthday: a.birthday,
          avatar: avatarUrl,
          friends: [],
          createdAt: new Date().toISOString()
        };
        db.collection('users').doc(cred.user.uid).set(userData).then(function() {
          userData.id = cred.user.uid;
          setState({userData: userData, authLoading: false});
        });
      };
      if (a.avatar) {
        var ref = storage.ref('avatars/' + cred.user.uid);
        ref.putString(a.avatar, 'data_url').then(function() {
          ref.getDownloadURL().then(saveUser);
        });
      } else {
        saveUser(null);
      }
    }).catch(function(e) {
      setState({authError: e.message, authLoading: false});
    });
  }

  function handleLogin() {
    var a = state.authData;
    if (!a.email || !a.password) return;
    setState({authLoading: true, authError: ''});
    auth.signInWithEmailAndPassword(a.email, a.password).then(function() {
      setState({authLoading: false});
    }).catch(function(e) {
      setState({authError: 'Invalid email or password', authLoading: false});
    });
  }

  function handleForgotPassword() {
    var email = state.authData.email;
    if (!email) {
      setState({authError: 'Please enter your email address first'});
      return;
    }
    setState({authLoading: true, authError: ''});
    auth.sendPasswordResetEmail(email).then(function() {
      setState({authLoading: false, authError: ''});
      alert('Password reset email sent! Check your inbox.');
    }).catch(function(e) {
      var msg = 'Could not send reset email';
      if (e.code === 'auth/user-not-found') {
        msg = 'No account found with this email';
      } else if (e.code === 'auth/invalid-email') {
        msg = 'Please enter a valid email address';
      }
      setState({authError: msg, authLoading: false});
    });
  }

  function handleLogout() {
    auth.signOut();
  }

  function startEditProfile() {
    setState({
      editingProfile: true,
      editProfile: {
        username: state.userData ? state.userData.username : '',
        avatar: state.userData ? state.userData.avatar : null,
        newAvatar: null
      }
    });
  }

  function saveProfile() {
    var ep = state.editProfile;
    if (!ep.username.trim()) {
      alert('Username cannot be empty');
      return;
    }
    setState({savingProfile: true});
    
    var updateData = {username: ep.username.trim()};
    
    var doUpdate = function(avatarUrl) {
      if (avatarUrl !== undefined) {
        updateData.avatar = avatarUrl;
      }
      db.collection('users').doc(state.user.uid).update(updateData).then(function() {
        state.userData.username = updateData.username;
        if (updateData.avatar !== undefined) {
          state.userData.avatar = updateData.avatar;
        }
        setState({savingProfile: false, editingProfile: false});
      }).catch(function(e) {
        console.error('Error saving profile:', e);
        setState({savingProfile: false});
        alert('Error saving profile');
      });
    };
    
    if (ep.newAvatar) {
      var ref = storage.ref('avatars/' + state.user.uid + '_' + Date.now());
      ref.putString(ep.newAvatar, 'data_url').then(function() {
        return ref.getDownloadURL();
      }).then(function(url) {
        doUpdate(url);
      }).catch(function(e) {
        console.error('Error uploading avatar:', e);
        setState({savingProfile: false});
        alert('Error uploading photo');
      });
    } else {
      doUpdate();
    }
  }

  function cancelEditProfile() {
    setState({editingProfile: false, editProfile: {username: '', avatar: null, newAvatar: null}});
  }

  function unfriend(friendId) {
    if (!confirm('Remove this friend?')) return;
    
    var myId = state.user.uid;
    
    // Remove from my friends list
    db.collection('users').doc(myId).get().then(function(doc) {
      var myFriends = doc.data().friends || [];
      var newFriends = [];
      for (var i = 0; i < myFriends.length; i++) {
        if (myFriends[i] !== friendId) newFriends.push(myFriends[i]);
      }
      return db.collection('users').doc(myId).update({friends: newFriends});
    }).then(function() {
      // Remove me from their friends list
      return db.collection('users').doc(friendId).get();
    }).then(function(doc) {
      var theirFriends = doc.data().friends || [];
      var newFriends = [];
      for (var i = 0; i < theirFriends.length; i++) {
        if (theirFriends[i] !== myId) newFriends.push(theirFriends[i]);
      }
      return db.collection('users').doc(friendId).update({friends: newFriends});
    }).then(function() {
      // Go back to profile
      nav('profile');
    }).catch(function(e) {
      console.error('Error unfriending:', e);
      alert('Error removing friend');
    });
  }

  function nav(v) {
    setState({
      view: v,
      sel: null,
      dayPost: null,
      friendProfile: null,
      friendDayPost: null,
      showAddFriend: false,
      authError: '',
      showMenu: false,
      activeEdit: null
    });
  }

  function uploadImage(dataUrl, path) {
    var ref = storage.ref(path);
    return ref.putString(dataUrl, 'data_url').then(function() {
      return ref.getDownloadURL();
    });
  }

  function submit() {
    var n = state.np;
    if (!n.photo || !n.outfit || !n.songTitle || !n.songArtist || !n.loc) return;
    setState({uploading: true});
    var ts = Date.now();
    var photoUrl, outfitUrl;
    uploadImage(n.photo, 'posts/' + state.user.uid + '/' + ts + '_photo').then(function(url) {
      photoUrl = url;
      return uploadImage(n.outfit, 'posts/' + state.user.uid + '/' + ts + '_outfit');
    }).then(function(url) {
      outfitUrl = url;
      var post = {
        userId: state.user.uid,
        date: new Date().toISOString().split('T')[0],
        location: n.loc,
        photo: photoUrl,
        outfitPhoto: outfitUrl,
        photoX: n.photoX,
        photoY: n.photoY,
        outfitX: n.outfitX,
        outfitY: n.outfitY,
        song: {title: n.songTitle, artist: n.songArtist},
        songFont: n.songFont,
        songColor: n.songColor,
        quote: n.quote,
        privateNote: n.privateNote,
        createdAt: new Date().toISOString()
      };
      return db.collection('posts').add(post).then(function(ref) {
        post.id = ref.id;
        state.myPosts.unshift(post);
        setState({
          posted: true,
          uploading: false,
          step: 1,
          np: {photo: null, outfit: null, songTitle: '', songArtist: '', loc: '', quote: '', privateNote: '', outfitX: 0, outfitY: 0, photoX: 0, photoY: 0, songFont: 0, songColor: 0}
        });
        nav('feed');
      });
    }).catch(function(e) {
      console.error(e);
      setState({uploading: false});
    });
  }

  function addFriend() {
    var code = state.friendCode.trim();
    if (!code) return;
    db.collection('users').where('username', '==', code).get().then(function(snap) {
      if (snap.empty) {
        alert('User not found');
        setState({friendCode: ''});
        return;
      }
      var fid = snap.docs[0].id;
      if (fid === state.user.uid) {
        alert("That's you!");
        setState({friendCode: ''});
        return;
      }
      sendFriendRequest(fid);
    });
  }

  function saveToCamera(post, owner) {
    setState({saving: true, showMenu: false});
    var c = document.createElement('div');
    c.style.cssText = 'position:fixed;left:-9999px;width:600px;background:#fff;font-family:-apple-system,sans-serif';
    document.body.appendChild(c);
    var font = FONTS[post.songFont || 0].v;
    var color = COLORS[post.songColor || 0];
    var avatarHtml = (owner && owner.avatar) ? '<img src="' + owner.avatar + '" style="width:100%;height:100%;object-fit:cover;border-radius:14px"/>' : ((owner && owner.username) ? owner.username[0].toUpperCase() : '?');
    var quoteHtml = post.quote ? '<p style="margin:14px 0 0;font-size:17px;font-style:italic;color:#2D2A26">"' + post.quote + '"</p>' : '';
    
    c.innerHTML = '<div style="background:#fff"><div style="position:relative;display:flex;height:360px"><div style="flex:1;overflow:hidden;position:relative"><img src="' + (post.outfitPhoto || post.outfit) + '" crossorigin="anonymous" style="width:100%;height:100%;object-fit:cover;object-position:' + (50 + (post.outfitX || 0)) + '% ' + (50 + (post.outfitY || 0)) + '%"/></div><div style="width:4px;background:#fff"></div><div style="flex:1;overflow:hidden;position:relative"><img src="' + post.photo + '" crossorigin="anonymous" style="width:100%;height:100%;object-fit:cover;object-position:' + (50 + (post.photoX || 0)) + '% ' + (50 + (post.photoY || 0)) + '%"/></div><div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center;text-shadow:0 2px 8px rgba(0,0,0,.95)"><p style="margin:0;font-size:20px;font-weight:600;color:' + color + ';font-family:' + font + '">üéµ ' + (post.song ? post.song.title : '') + '</p><p style="margin:4px 0 0;font-size:15px;color:' + color + ';font-family:' + font + '">' + (post.song ? post.song.artist : '') + '</p></div><div style="position:absolute;top:12px;left:50%;transform:translateX(-50%);background:#E07A5F;color:#fff;padding:6px 16px;border-radius:8px;font-size:12px;font-weight:700">üìÆ POSTCARD</div></div><div style="padding:20px;border-top:2px solid #E8E4DF"><div style="display:flex;align-items:center;gap:12px"><div style="width:44px;height:44px;border-radius:14px;background:#E07A5F;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;color:#fff;overflow:hidden">' + avatarHtml + '</div><div><p style="margin:0;font-size:17px;font-weight:600;color:#2D2A26">' + (owner ? owner.username : 'You') + '</p><p style="margin:2px 0 0;font-size:13px;color:#8B8680">üìç ' + (post.location || '') + ' ¬∑ ' + (post.date || '') + '</p></div></div>' + quoteHtml + '</div></div>';
    
    var imgs = c.querySelectorAll('img');
    var loaded = 0;
    var total = imgs.length;
    
    function checkReady() {
      loaded++;
      if (loaded >= total) {
        doCapture();
      }
    }
    
    function doCapture() {
      html2canvas(c, {scale: 2, useCORS: true, allowTaint: true, backgroundColor: '#fff'}).then(function(canvas) {
        document.body.removeChild(c);
        var dataUrl = canvas.toDataURL('image/png');
        
        // Check if iOS
        var isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        
        if (isIOS) {
          // On iOS, show the image so user can long-press to save
          setState({saving: false, savedImage: dataUrl});
        } else {
          // On other devices, trigger download
          canvas.toBlob(function(blob) {
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'postcard-' + (post.date || new Date().toISOString().split('T')[0]) + '.png';
            a.click();
            URL.revokeObjectURL(url);
            setState({saving: false});
          }, 'image/png');
        }
      }).catch(function(e) {
        console.error(e);
        document.body.removeChild(c);
        setState({saving: false});
        alert('Could not save');
      });
    }
    
    if (total === 0) {
      doCapture();
    } else {
      for (var i = 0; i < imgs.length; i++) {
        if (imgs[i].complete) {
          checkReady();
        } else {
          imgs[i].onload = checkReady;
          imgs[i].onerror = checkReady;
        }
      }
    }
  }

  function deletePost(id) {
    if (!confirm('Delete this postcard?')) return;
    setState({showMenu: false});
    db.collection('posts').doc(id).delete().then(function() {
      var newPosts = [];
      for (var i = 0; i < state.myPosts.length; i++) {
        if (state.myPosts[i].id !== id) newPosts.push(state.myPosts[i]);
      }
      var today = new Date().toISOString().split('T')[0];
      var hasPosted = false;
      for (var i = 0; i < newPosts.length; i++) {
        if (newPosts[i].date === today) hasPosted = true;
      }
      state.myPosts = newPosts;
      setState({posted: hasPosted});
      nav('feed');
    });
  }

  function toggleReaction(postId, ownerId, emoji) {
    if (!state.user) return;
    var uid = state.user.uid;
    
    // Find the post in friends' posts
    for (var i = 0; i < state.friends.length; i++) {
      var f = state.friends[i];
      if (f.id === ownerId && f.posts) {
        for (var j = 0; j < f.posts.length; j++) {
          if (f.posts[j].id === postId) {
            var post = f.posts[j];
            var reactions = post.reactions || {};
            
            // Toggle reaction
            if (reactions[uid] === emoji) {
              delete reactions[uid];
            } else {
              reactions[uid] = emoji;
            }
            
            // Update Firestore
            db.collection('posts').doc(postId).update({reactions: reactions}).then(function() {
              post.reactions = reactions;
              render();
            }).catch(function(e) {
              console.error('Error updating reaction:', e);
            });
            return;
          }
        }
      }
    }
  }

  function getAllTodayPosts() {
    var today = new Date().toISOString().split('T')[0];
    var result = [];
    for (var i = 0; i < state.myPosts.length; i++) {
      if (state.myPosts[i].date === today) {
        var p = {};
        for (var k in state.myPosts[i]) p[k] = state.myPosts[i][k];
        p.friend = {};
        for (var k in state.userData) p.friend[k] = state.userData[k];
        p.friend.id = state.user ? state.user.uid : null;
        result.push(p);
      }
    }
    for (var i = 0; i < state.friends.length; i++) {
      var f = state.friends[i];
      var posts = f.posts || [];
      for (var j = 0; j < posts.length; j++) {
        if (posts[j].date === today) {
          var p = {};
          for (var k in posts[j]) p[k] = posts[j][k];
          p.friend = f;
          result.push(p);
        }
      }
    }
    return result;
  }

  function getPostForDate(day) {
    var d = state.calDate;
    var month = String(d.getMonth() + 1);
    if (month.length < 2) month = '0' + month;
    var dayStr = String(day);
    if (dayStr.length < 2) dayStr = '0' + dayStr;
    var ds = d.getFullYear() + '-' + month + '-' + dayStr;
    for (var i = 0; i < state.myPosts.length; i++) {
      if (state.myPosts[i].date === ds) return state.myPosts[i];
    }
    return null;
  }

  function getDaysInMonth(d) {
    return new Date(d.getFullYear(), d.getMonth() + 1, 0).getDate();
  }

  function getStartDay(d) {
    return new Date(d.getFullYear(), d.getMonth(), 1).getDay();
  }

  function fmtMonth(d) {
    var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    return months[d.getMonth()] + ' ' + d.getFullYear();
  }

  function getBirthdaysForDate(month, day) {
    var birthdays = [];
    // Check friends
    for (var i = 0; i < state.friends.length; i++) {
      var f = state.friends[i];
      if (f.birthday) {
        var parts = f.birthday.split('-');
        var bMonth = parseInt(parts[1], 10);
        var bDay = parseInt(parts[2], 10);
        if (bMonth === month && bDay === day) {
          birthdays.push(f);
        }
      }
    }
    // Check own birthday
    if (state.userData && state.userData.birthday) {
      var parts = state.userData.birthday.split('-');
      var bMonth = parseInt(parts[1], 10);
      var bDay = parseInt(parts[2], 10);
      if (bMonth === month && bDay === day) {
        birthdays.push(state.userData);
      }
    }
    return birthdays;
  }

  function el(tag, attrs, children) {
    var e = document.createElement(tag);
    if (attrs) {
      for (var k in attrs) {
        if (k === 'style' && typeof attrs[k] === 'object') {
          for (var s in attrs[k]) {
            e.style[s] = attrs[k][s];
          }
        } else if (k.substring(0, 2) === 'on') {
          e.addEventListener(k.substring(2).toLowerCase(), attrs[k]);
        } else if (k === 'className') {
          e.className = attrs[k];
        } else {
          e.setAttribute(k, attrs[k]);
        }
      }
    }
    if (children !== undefined && children !== null) {
      if (Array.isArray(children)) {
        for (var i = 0; i < children.length; i++) {
          if (children[i]) {
            if (typeof children[i] === 'string') {
              e.appendChild(document.createTextNode(children[i]));
            } else {
              e.appendChild(children[i]);
            }
          }
        }
      } else if (typeof children === 'string' || typeof children === 'number') {
        e.textContent = children;
      } else {
        e.appendChild(children);
      }
    }
    return e;
  }

  function postcardEl(post, owner, opts) {
    opts = opts || {};
    var font = FONTS[post.songFont || 0].v;
    var color = COLORS[post.songColor || 0];
    var imgHeight = opts.compact ? '200px' : '280px';
    
    var wrap = el('div', {style: {position: 'relative'}});
    var card = el('div', {style: {background: t.card, borderRadius: '16px', border: '1px solid ' + t.border, overflow: 'hidden', boxShadow: '0 4px 12px rgba(0,0,0,.08)'}});
    
    var imgArea = el('div', {style: {position: 'relative', display: 'flex', height: imgHeight}});
    
    // Left
    var left = el('div', {style: {flex: '1', overflow: 'hidden', position: 'relative'}});
    left.appendChild(el('img', {src: post.outfitPhoto || post.outfit, style: {width: '100%', height: '100%', objectFit: 'cover', objectPosition: (50 + (post.outfitX || 0)) + '% ' + (50 + (post.outfitY || 0)) + '%'}}));
    
    // Divider
    var divider = el('div', {style: {width: '3px', background: t.card}});
    
    // Right
    var right = el('div', {style: {flex: '1', overflow: 'hidden', position: 'relative'}});
    right.appendChild(el('img', {src: post.photo, style: {width: '100%', height: '100%', objectFit: 'cover', objectPosition: (50 + (post.photoX || 0)) + '% ' + (50 + (post.photoY || 0)) + '%'}}));
    
    // Song
    var song = el('div', {style: {position: 'absolute', left: '50%', top: '50%', transform: 'translate(-50%,-50%)', textAlign: 'center', textShadow: '0 2px 8px rgba(0,0,0,.95),0 0 20px rgba(0,0,0,.5)', padding: '10px 16px'}});
    song.appendChild(el('p', {style: {margin: '0', fontSize: '15px', fontWeight: '600', color: color, fontFamily: font}}, 'üéµ ' + (post.song ? post.song.title : '')));
    song.appendChild(el('p', {style: {margin: '3px 0 0', fontSize: '12px', color: color, fontFamily: font, opacity: '0.95'}}, post.song ? post.song.artist : ''));
    
    imgArea.appendChild(left);
    imgArea.appendChild(divider);
    imgArea.appendChild(right);
    imgArea.appendChild(song);
    
    // Stamp - only show if not in feed
    if (opts.showStamp) {
      var stamp = el('div', {style: {position: 'absolute', top: '10px', left: '50%', transform: 'translateX(-50%)', background: t.accent, color: '#fff', padding: '5px 12px', borderRadius: '6px', fontSize: '10px', fontWeight: '700'}}, 'üìÆ POSTCARD');
      imgArea.appendChild(stamp);
    }
    
    // Bottom
    var bottom = el('div', {style: {padding: '14px', borderTop: '1px solid ' + t.border}});
    var info = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px'}});
    
    var avatar;
    if (owner && owner.avatar) {
      avatar = el('img', {src: owner.avatar, style: {width: '32px', height: '32px', borderRadius: '10px', objectFit: 'cover'}});
    } else {
      avatar = el('div', {style: {width: '32px', height: '32px', borderRadius: '10px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '13px', fontWeight: '600', color: '#fff'}}, (owner && owner.username) ? owner.username[0].toUpperCase() : '?');
    }
    
    var meta = el('div', {style: {flex: '1'}});
    var isMe = owner && state.user && owner.id === state.user.uid;
    meta.appendChild(el('p', {style: {margin: '0', fontSize: '13px', fontWeight: '600', color: t.text}}, isMe ? 'You' : (owner ? owner.username : 'User')));
    
    // Format date and time
    var dateTimeStr = 'üìç ' + post.location + ' ¬∑ ' + post.date;
    if (post.createdAt) {
      var postTime = new Date(post.createdAt);
      var hours = postTime.getHours();
      var minutes = postTime.getMinutes();
      var ampm = hours >= 12 ? 'pm' : 'am';
      hours = hours % 12;
      hours = hours ? hours : 12;
      var timeStr = hours + ':' + (minutes < 10 ? '0' : '') + minutes + ampm;
      dateTimeStr += ' ¬∑ ' + timeStr;
    }
    meta.appendChild(el('p', {style: {margin: '0', fontSize: '11px', color: t.muted}}, dateTimeStr));
    
    info.appendChild(avatar);
    info.appendChild(meta);
    bottom.appendChild(info);
    
    if (post.quote) {
      bottom.appendChild(el('p', {style: {margin: '10px 0 0', fontSize: '14px', fontStyle: 'italic', color: t.text}}, '"' + post.quote + '"'));
    }
    
    if (opts.showPrivate && post.privateNote) {
      var pn = el('div', {style: {marginTop: '8px', padding: '8px', background: '#fff8e1', borderRadius: '6px', border: '1px dashed #ffc107'}});
      pn.appendChild(el('p', {style: {margin: '0', fontSize: '10px', color: '#f57c00'}}, 'üîí ' + post.privateNote));
      bottom.appendChild(pn);
    }
    
    // Reactions - only for friends' posts in feed
    if (opts.showReactions && post.id) {
      var reactions = post.reactions || {};
      var myReaction = state.user ? (reactions[state.user.uid] || null) : null;
      var reactionEmojis = ['‚ù§Ô∏è', 'üî•', 'üòç', 'üëè', '‚ú®'];
      
      // Reaction buttons row
      var reactWrap = el('div', {style: {marginTop: '12px', display: 'flex', gap: '8px', flexWrap: 'wrap'}});
      
      for (var i = 0; i < reactionEmojis.length; i++) {
        (function(emoji) {
          var isSelected = myReaction === emoji;
          
          var btn = el('span', {
            className: 'tap',
            style: {
              display: 'flex',
              alignItems: 'center',
              justifyContent: 'center',
              width: '40px',
              height: '40px',
              borderRadius: '50%',
              fontSize: '18px',
              background: isSelected ? t.accent + '22' : t.bg,
              border: '2px solid ' + (isSelected ? t.accent : t.border)
            },
            onClick: function() {
              toggleReaction(post.id, owner.id, emoji);
            }
          }, emoji);
          reactWrap.appendChild(btn);
        })(reactionEmojis[i]);
      }
      
      bottom.appendChild(reactWrap);
      
      // Show confirmed reactions below (who reacted with what)
      var hasReactions = false;
      for (var uid in reactions) {
        if (reactions[uid]) {
          hasReactions = true;
          break;
        }
      }
      
      if (hasReactions) {
        var confirmedWrap = el('div', {style: {marginTop: '10px', display: 'flex', flexWrap: 'wrap', gap: '6px'}});
        
        for (var uid in reactions) {
          (function(reactorId, emoji) {
            // Find reactor name
            var reactorName = 'Someone';
            if (state.user && reactorId === state.user.uid) {
              reactorName = 'You';
            } else {
              for (var fi = 0; fi < state.friends.length; fi++) {
                if (state.friends[fi].id === reactorId) {
                  reactorName = state.friends[fi].username;
                  break;
                }
              }
            }
            
            var chip = el('span', {style: {
              display: 'inline-flex',
              alignItems: 'center',
              gap: '4px',
              padding: '4px 10px',
              borderRadius: '12px',
              fontSize: '12px',
              background: t.bg,
              color: t.muted
            }});
            chip.appendChild(el('span', {style: {fontSize: '14px'}}, emoji));
            chip.appendChild(el('span', null, reactorName));
            confirmedWrap.appendChild(chip);
          })(uid, reactions[uid]);
        }
        
        bottom.appendChild(confirmedWrap);
      }
    }
    
    card.appendChild(imgArea);
    card.appendChild(bottom);
    wrap.appendChild(card);
    
    // Menu
    if (opts.showMenu && opts.isOwner) {
      var menuWrap = el('div', {style: {display: 'flex', justifyContent: 'center', marginTop: '12px'}});
      var menuRel = el('div', {style: {position: 'relative'}});
      
      var dots = el('span', {className: 'tap', style: {display: 'flex', gap: '4px', padding: '8px 16px', background: t.card, borderRadius: '20px', border: '1px solid ' + t.border, alignItems: 'center'}, onClick: function() { setState({showMenu: !state.showMenu}); }});
      dots.appendChild(el('span', {style: {width: '5px', height: '5px', borderRadius: '50%', background: t.muted}}));
      dots.appendChild(el('span', {style: {width: '5px', height: '5px', borderRadius: '50%', background: t.muted}}));
      dots.appendChild(el('span', {style: {width: '5px', height: '5px', borderRadius: '50%', background: t.muted}}));
      menuRel.appendChild(dots);
      
      if (state.showMenu) {
        var backdrop = el('div', {style: {position: 'fixed', top: '0', left: '0', right: '0', bottom: '0', zIndex: '99'}, onClick: function() { setState({showMenu: false}); }});
        menuRel.appendChild(backdrop);
        
        var dropdown = el('div', {style: {position: 'absolute', bottom: '100%', left: '50%', transform: 'translateX(-50%)', marginBottom: '8px', background: t.card, borderRadius: '14px', border: '1px solid ' + t.border, boxShadow: '0 4px 20px rgba(0,0,0,.15)', overflow: 'hidden', zIndex: '100', minWidth: '200px'}});
        
        var saveBtn = el('span', {className: 'tap', style: {display: 'flex', alignItems: 'center', gap: '12px', padding: '14px 18px', color: t.text, fontSize: '14px', fontWeight: '500', borderBottom: '1px solid ' + t.border}, onClick: function() { saveToCamera(post, owner); }});
        saveBtn.appendChild(el('span', {style: {fontSize: '18px'}}, 'üíæ'));
        saveBtn.appendChild(document.createTextNode('Save to Photos'));
        
        var delBtn = el('span', {className: 'tap', style: {display: 'flex', alignItems: 'center', gap: '12px', padding: '14px 18px', color: '#e53935', fontSize: '14px', fontWeight: '500'}, onClick: function() { deletePost(post.id); }});
        delBtn.appendChild(el('span', {style: {fontSize: '18px'}}, 'üóëÔ∏è'));
        delBtn.appendChild(document.createTextNode('Delete Post'));
        
        dropdown.appendChild(saveBtn);
        dropdown.appendChild(delBtn);
        menuRel.appendChild(dropdown);
      }
      
      menuWrap.appendChild(menuRel);
      wrap.appendChild(menuWrap);
    }
    
    return wrap;
  }

  function render() {
    t = state.dark ? D : L;
    document.body.style.background = t.bg;
    var app = document.getElementById('app');
    app.innerHTML = '';
    
    // Saving overlay
    if (state.saving) {
      var overlay = el('div', {style: {position: 'fixed', top: '0', left: '0', right: '0', bottom: '0', background: 'rgba(0,0,0,.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: '1000'}});
      var box = el('div', {style: {background: t.card, padding: '28px', borderRadius: '20px', textAlign: 'center'}});
      box.appendChild(el('div', {style: {fontSize: '32px', marginBottom: '12px'}}, 'üíæ'));
      box.appendChild(el('p', {style: {margin: '0', fontSize: '16px', fontWeight: '500', color: t.text}}, 'Creating image...'));
      overlay.appendChild(box);
      app.appendChild(overlay);
    }
    
    // Saved image overlay (for iOS)
    if (state.savedImage) {
      var overlay = el('div', {style: {position: 'fixed', top: '0', left: '0', right: '0', bottom: '0', background: 'rgba(0,0,0,.9)', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', zIndex: '1000', padding: '20px'}});
      
      overlay.appendChild(el('p', {style: {color: '#fff', fontSize: '16px', fontWeight: '600', marginBottom: '16px', textAlign: 'center'}}, 'üì± Hold down on image to save'));
      
      var img = el('img', {src: state.savedImage, style: {maxWidth: '100%', maxHeight: '70vh', borderRadius: '12px', boxShadow: '0 4px 20px rgba(0,0,0,.3)'}});
      overlay.appendChild(img);
      
      overlay.appendChild(el('p', {style: {color: '#aaa', fontSize: '13px', marginTop: '12px', textAlign: 'center'}}, 'Long press ‚Üí "Add to Photos"'));
      
      var closeBtn = el('span', {className: 'tap', style: {marginTop: '20px', padding: '14px 32px', background: t.accent, color: '#fff', borderRadius: '12px', fontSize: '15px', fontWeight: '600'}, onClick: function() { setState({savedImage: null}); }}, 'Done');
      overlay.appendChild(closeBtn);
      
      app.appendChild(overlay);
    }
    
    // Auth
    if (state.view === 'auth') {
      var page = el('div', {style: {padding: '20px', display: 'flex', flexDirection: 'column', minHeight: '100vh', justifyContent: 'center'}});
      
      var logo = el('div', {style: {textAlign: 'center', marginBottom: '40px'}});
      logo.appendChild(el('div', {style: {fontSize: '60px', marginBottom: '8px'}}, 'üìÆ'));
      logo.appendChild(el('h1', {style: {margin: '0', fontSize: '32px', fontWeight: '700', color: t.text}}, 'postcard'));
      logo.appendChild(el('p', {style: {margin: '8px 0 0', color: t.muted}}, 'Share your day with friends'));
      page.appendChild(logo);
      
      var tabs = el('div', {style: {display: 'flex', marginBottom: '24px', background: t.card, borderRadius: '12px', padding: '4px', border: '1px solid ' + t.border}});
      var loginTab = el('span', {className: 'tap', style: {flex: '1', padding: '12px', borderRadius: '8px', textAlign: 'center', fontSize: '14px', fontWeight: '600', background: state.authMode === 'login' ? t.accent : 'transparent', color: state.authMode === 'login' ? '#fff' : t.muted}, onClick: function() { setState({authMode: 'login', authError: ''}); }}, 'Log In');
      var signupTab = el('span', {className: 'tap', style: {flex: '1', padding: '12px', borderRadius: '8px', textAlign: 'center', fontSize: '14px', fontWeight: '600', background: state.authMode === 'signup' ? t.accent : 'transparent', color: state.authMode === 'signup' ? '#fff' : t.muted}, onClick: function() { setState({authMode: 'signup', authError: ''}); }}, 'Sign Up');
      tabs.appendChild(loginTab);
      tabs.appendChild(signupTab);
      page.appendChild(tabs);
      
      if (state.authMode === 'signup') {
        var avatarWrap = el('div', {style: {display: 'flex', justifyContent: 'center', marginBottom: '20px'}});
        var avatarInput = el('input', {type: 'file', accept: 'image/*', style: {display: 'none'}, id: 'avatarInput'});
        avatarInput.onchange = function(e) {
          var f = e.target.files[0];
          if (f) {
            var r = new FileReader();
            r.onloadend = function() { setAuthData({avatar: r.result}); };
            r.readAsDataURL(f);
          }
        };
        var avatarLabel = el('label', {className: 'tap', for: 'avatarInput'});
        if (state.authData.avatar) {
          avatarLabel.appendChild(el('img', {src: state.authData.avatar, style: {width: '80px', height: '80px', borderRadius: '24px', objectFit: 'cover', border: '3px solid ' + t.accent}}));
        } else {
          var ph = el('div', {style: {width: '80px', height: '80px', borderRadius: '24px', background: t.card, border: '2px dashed ' + t.border, display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '4px'}});
          ph.appendChild(el('span', {style: {fontSize: '24px'}}, 'üì∑'));
          ph.appendChild(el('span', {style: {fontSize: '10px', color: t.muted}}, 'Add photo'));
          avatarLabel.appendChild(ph);
        }
        avatarWrap.appendChild(avatarInput);
        avatarWrap.appendChild(avatarLabel);
        page.appendChild(avatarWrap);
      }
      
      if (state.authError) {
        page.appendChild(el('div', {style: {padding: '12px', marginBottom: '12px', borderRadius: '10px', background: '#ffebee', color: '#c62828', fontSize: '13px', textAlign: 'center'}}, state.authError));
      }
      
      var fields = el('div', {style: {display: 'flex', flexDirection: 'column', gap: '12px'}});
      
      if (state.authMode === 'signup') {
        var userField = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px', padding: '14px', borderRadius: '14px', border: '1px solid ' + t.border, background: t.card}});
        userField.appendChild(el('span', null, 'üë§'));
        var userInput = el('input', {placeholder: 'Username', value: state.authData.username, style: {flex: '1', background: 'transparent', border: 'none', fontSize: '15px', color: t.text, outline: 'none'}});
        userInput.oninput = function(e) { state.authData.username = e.target.value; };
        userField.appendChild(userInput);
        fields.appendChild(userField);
      }
      
      var emailField = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px', padding: '14px', borderRadius: '14px', border: '1px solid ' + t.border, background: t.card}});
      emailField.appendChild(el('span', null, '‚úâÔ∏è'));
      var emailInput = el('input', {type: 'email', placeholder: 'Email', value: state.authData.email, style: {flex: '1', background: 'transparent', border: 'none', fontSize: '15px', color: t.text, outline: 'none'}});
      emailInput.oninput = function(e) { state.authData.email = e.target.value; };
      emailField.appendChild(emailInput);
      fields.appendChild(emailField);
      
      var passField = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px', padding: '14px', borderRadius: '14px', border: '1px solid ' + t.border, background: t.card}});
      passField.appendChild(el('span', null, 'üîí'));
      var passInput = el('input', {type: 'password', placeholder: 'Password (6+ chars)', value: state.authData.password, style: {flex: '1', background: 'transparent', border: 'none', fontSize: '15px', color: t.text, outline: 'none'}});
      passInput.oninput = function(e) { state.authData.password = e.target.value; };
      passField.appendChild(passInput);
      fields.appendChild(passField);
      
      if (state.authMode === 'login') {
        var forgotLink = el('span', {className: 'tap', style: {display: 'block', textAlign: 'right', fontSize: '13px', color: t.accent, marginTop: '8px'}, onClick: handleForgotPassword}, 'Forgot password?');
        fields.appendChild(forgotLink);
      }
      
      if (state.authMode === 'signup') {
        var bdayField = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px', padding: '14px', borderRadius: '14px', border: '1px solid ' + t.border, background: t.card}});
        bdayField.appendChild(el('span', null, 'üéÇ'));
        var bdayInput = el('input', {type: 'date', value: state.authData.birthday, style: {flex: '1', background: 'transparent', border: 'none', fontSize: '15px', color: t.text, outline: 'none'}});
        bdayInput.oninput = function(e) { state.authData.birthday = e.target.value; };
        bdayField.appendChild(bdayInput);
        fields.appendChild(bdayField);
        fields.appendChild(el('p', {style: {margin: '0', fontSize: '11px', color: t.muted, textAlign: 'center'}}, 'Friends will see your birthday'));
      }
      
      page.appendChild(fields);
      
      var submitBtn = el('span', {className: 'tap', style: {marginTop: '24px', color: '#fff', padding: '16px', borderRadius: '14px', fontSize: '16px', fontWeight: '600', textAlign: 'center', background: t.accent, opacity: state.authLoading ? '0.5' : '1', display: 'block'}, onClick: state.authMode === 'login' ? handleLogin : handleSignup}, state.authLoading ? 'Please wait...' : (state.authMode === 'login' ? 'Log In' : 'Create Account'));
      page.appendChild(submitBtn);
      
      app.appendChild(page);
      return;
    }
    
    // Feed
    if (state.view === 'feed') {
      var page = el('div', {style: {minHeight: '100vh', paddingBottom: '100px'}});
      
      var header = el('header', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 20px'}});
      var logoWrap = el('div', {style: {display: 'flex', alignItems: 'center', gap: '8px'}});
      logoWrap.appendChild(el('span', {style: {fontSize: '26px', fontWeight: '700', color: t.text}}, 'postcard'));
      logoWrap.appendChild(el('span', {style: {fontSize: '18px'}}, '‚úàÔ∏è'));
      
      var btns = el('div', {style: {display: 'flex', gap: '8px'}});
      btns.appendChild(el('span', {className: 'tap', style: {fontSize: '20px', padding: '8px', color: t.muted}, onClick: function() { nav('settings'); }}, '‚öôÔ∏è'));
      var profBtn = el('span', {className: 'tap', style: {padding: '8px', position: 'relative'}, onClick: function() { nav('profile'); }});
      if (state.userData && state.userData.avatar) {
        profBtn.appendChild(el('img', {src: state.userData.avatar, style: {width: '36px', height: '36px', borderRadius: '12px', objectFit: 'cover'}}));
      } else {
        profBtn.appendChild(el('div', {style: {width: '36px', height: '36px', borderRadius: '12px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: '600', color: '#fff'}}, (state.userData && state.userData.username) ? state.userData.username[0].toUpperCase() : '?'));
      }
      if (state.friendRequests.length > 0) {
        profBtn.appendChild(el('div', {style: {position: 'absolute', top: '4px', right: '4px', width: '18px', height: '18px', borderRadius: '50%', background: '#e53935', color: '#fff', fontSize: '11px', fontWeight: '700', display: 'flex', alignItems: 'center', justifyContent: 'center', border: '2px solid ' + t.bg}}, state.friendRequests.length));
      }
      btns.appendChild(profBtn);
      
      header.appendChild(logoWrap);
      header.appendChild(btns);
      page.appendChild(header);
      
      if (!state.posted) {
        var cta = el('div', {style: {margin: '0 20px 20px', padding: '24px', borderRadius: '20px', textAlign: 'center', border: '2px dashed ' + t.border, background: t.card}});
        cta.appendChild(el('div', {style: {fontSize: '40px', marginBottom: '8px'}}, 'üìÆ'));
        cta.appendChild(el('p', {style: {color: t.text, margin: '0 0 14px', fontSize: '15px'}}, "Share your day to see friends' postcards"));
        cta.appendChild(el('span', {className: 'tap', style: {display: 'inline-block', color: '#fff', padding: '14px 28px', borderRadius: '14px', fontSize: '15px', fontWeight: '600', background: t.accent}, onClick: function() { nav('post'); }}, 'Send postcard ‚úâÔ∏è'));
        page.appendChild(cta);
      }
      
      var posts = getAllTodayPosts();
      if (posts.length === 0 && state.posted) {
        var empty = el('div', {style: {padding: '40px 20px', textAlign: 'center'}});
        empty.appendChild(el('p', {style: {color: t.muted, fontSize: '15px'}}, 'No postcards from friends today yet.'));
        page.appendChild(empty);
      }
      
      var postsWrap = el('div', {style: {padding: '0 20px', display: 'flex', flexDirection: 'column', gap: '16px'}});
      for (var i = 0; i < posts.length; i++) {
        (function(p) {
          var isMyPost = state.user && p.userId === state.user.uid;
          var item = el('div');
          item.appendChild(postcardEl(p, p.friend, {
            showPrivate: isMyPost,
            showReactions: !isMyPost,
            showStamp: false
          }));
          postsWrap.appendChild(item);
        })(posts[i]);
      }
      page.appendChild(postsWrap);
      
      var navbar = el('nav', {style: {position: 'fixed', bottom: '0', left: '50%', transform: 'translateX(-50%)', width: '100%', maxWidth: '430px', padding: '16px 20px 34px', display: 'flex', justifyContent: 'space-around', alignItems: 'center', background: 'linear-gradient(transparent,' + t.bg + ')'}});
      navbar.appendChild(el('span', {style: {fontSize: '24px', padding: '12px'}}, 'üè†'));
      navbar.appendChild(el('span', {className: 'tap', style: {width: '56px', height: '56px', borderRadius: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', color: '#fff', background: t.accent}, onClick: function() { nav('post'); }}, '+'));
      navbar.appendChild(el('span', {className: 'tap', style: {fontSize: '24px', padding: '12px', opacity: '0.5'}, onClick: function() { nav('profile'); }}, 'üë§'));
      page.appendChild(navbar);
      
      app.appendChild(page);
      return;
    }
    
    // Detail
    if (state.view === 'detail' && state.sel) {
      var page = el('div', {style: {minHeight: '100vh', padding: '16px'}});
      page.appendChild(el('span', {className: 'tap', style: {position: 'absolute', top: '16px', right: '16px', width: '36px', height: '36px', borderRadius: '12px', fontSize: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: t.card, color: t.text, zIndex: '10'}, onClick: function() { nav('feed'); }}, '‚úï'));
      var wrap = el('div', {style: {paddingTop: '40px'}});
      var isOwner = state.user && state.sel.userId === state.user.uid;
      wrap.appendChild(postcardEl(state.sel, state.sel.friend, {showPrivate: isOwner, isOwner: isOwner, showMenu: true, showStamp: true}));
      page.appendChild(wrap);
      app.appendChild(page);
      return;
    }
    
    // Post (Steps 1-4)
    if (state.view === 'post') {
      var page = el('div', {style: {minHeight: '100vh', padding: '0 20px 40px'}});
      
      var header = el('header', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 0'}});
      header.appendChild(el('span', {className: 'tap', style: {fontSize: '28px', padding: '8px 12px', color: t.text}, onClick: function() { if (state.step > 1) setState({step: state.step - 1}); else nav('feed'); }}, '‚Üê'));
      var titles = ['', 'üì∏ Photos', 'üéµ Details', '‚úèÔ∏è Edit', '‚úì Preview'];
      header.appendChild(el('span', {style: {fontWeight: '600', color: t.text}}, titles[state.step]));
      header.appendChild(el('span', {style: {color: t.muted, padding: '8px 12px'}}, state.step + '/4'));
      page.appendChild(header);
      
      // Step 1: Photos
      if (state.step === 1) {
        var content = el('div', {style: {display: 'flex', flexDirection: 'column', gap: '16px'}});
        content.appendChild(el('p', {style: {color: t.muted, textAlign: 'center', margin: '0', fontSize: '14px'}}, 'Outfit (left) & Photo (right)'));
        
        var grid = el('div', {style: {display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px'}});
        var keys = ['outfit', 'photo'];
        var icons = ['üëï', 'üì∑'];
        var labels = ['Outfit', 'Photo'];
        
        for (var i = 0; i < 2; i++) {
          (function(idx) {
            var k = keys[idx];
            var box = el('div', {style: {aspectRatio: '3/4', borderRadius: '16px', overflow: 'hidden', border: '2px dashed ' + t.border, background: t.card}});
            var input = el('input', {type: 'file', accept: 'image/*', style: {display: 'none'}, id: k + 'Input'});
            input.onchange = function(e) {
              var f = e.target.files[0];
              if (f) {
                var r = new FileReader();
                r.onloadend = function() {
                  var upd = {};
                  upd[k] = r.result;
                  setNp(upd);
                };
                r.readAsDataURL(f);
              }
            };
            var label = el('label', {for: k + 'Input', style: {width: '100%', height: '100%', display: 'flex', cursor: 'pointer'}});
            if (state.np[k]) {
              label.appendChild(el('img', {src: state.np[k], style: {width: '100%', height: '100%', objectFit: 'cover'}}));
            } else {
              var ph = el('div', {style: {width: '100%', height: '100%', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', gap: '8px'}});
              ph.appendChild(el('span', {style: {fontSize: '40px'}}, icons[idx]));
              ph.appendChild(el('span', {style: {color: t.muted, fontSize: '14px'}}, labels[idx]));
              label.appendChild(ph);
            }
            box.appendChild(input);
            box.appendChild(label);
            grid.appendChild(box);
          })(i);
        }
        content.appendChild(grid);
        
        var canNext = state.np.photo && state.np.outfit;
        content.appendChild(el('span', {className: 'tap', style: {color: '#fff', padding: '18px', borderRadius: '14px', fontSize: '16px', fontWeight: '600', textAlign: 'center', background: t.accent, opacity: canNext ? '1' : '0.4', display: 'block'}, onClick: function() { if (canNext) setState({step: 2}); }}, 'Next ‚Üí'));
        
        page.appendChild(content);
      }
      
      // Step 2: Details
      if (state.step === 2) {
        var content = el('div', {style: {display: 'flex', flexDirection: 'column', gap: '14px'}});
        
        var fieldsData = [
          {icon: 'üéµ', key: 'songTitle', ph: 'Song title'},
          {icon: 'üé§', key: 'songArtist', ph: 'Artist'},
          {icon: 'üìç', key: 'loc', ph: 'Location'},
          {icon: 'üí¨', key: 'quote', ph: 'Quote (optional)'},
          {icon: 'üîí', key: 'privateNote', ph: 'Private note (only visible to you)', bg: '#fff8e1'}
        ];
        
        for (var i = 0; i < fieldsData.length; i++) {
          (function(f) {
            var field = el('div', {style: {display: 'flex', alignItems: 'center', gap: '12px', padding: '16px', borderRadius: '14px', border: '1px solid ' + t.border, background: f.bg || t.card}});
            field.appendChild(el('span', {style: {fontSize: '18px'}}, f.icon));
            var input = el('input', {placeholder: f.ph, value: state.np[f.key], style: {flex: '1', background: 'transparent', border: 'none', fontSize: '16px', color: t.text, outline: 'none'}});
            input.oninput = function(e) {
              state.np[f.key] = e.target.value;
              // Update button state without full re-render
              var nextBtn = document.getElementById('step2NextBtn');
              if (nextBtn) {
                var canGo = state.np.songTitle && state.np.songArtist && state.np.loc;
                nextBtn.style.opacity = canGo ? '1' : '0.4';
                nextBtn.style.background = canGo ? t.accent : t.border;
              }
            };
            field.appendChild(input);
            content.appendChild(field);
          })(fieldsData[i]);
        }
        
        var btns = el('div', {style: {display: 'flex', gap: '12px', marginTop: '8px'}});
        btns.appendChild(el('span', {className: 'tap', style: {padding: '16px 24px', border: '1px solid ' + t.border, borderRadius: '14px', fontSize: '15px', color: t.text, background: t.card}, onClick: function() { setState({step: 1}); }}, '‚Üê'));
        var canNext = state.np.songTitle && state.np.songArtist && state.np.loc;
        var nextBtn = el('span', {className: 'tap', id: 'step2NextBtn', style: {flex: '1', color: '#fff', padding: '18px', borderRadius: '14px', fontSize: '16px', fontWeight: '600', textAlign: 'center', background: canNext ? t.accent : t.border, opacity: canNext ? '1' : '0.4'}, onClick: function() { if (state.np.songTitle && state.np.songArtist && state.np.loc) setState({step: 3}); }}, 'Next ‚Üí');
        btns.appendChild(nextBtn);
        content.appendChild(btns);
        
        page.appendChild(content);
      }
      
      // Step 3: Edit
      if (state.step === 3) {
        var content = el('div', {style: {display: 'flex', flexDirection: 'column', gap: '20px'}});
        
        // Preview
        var preview = el('div', {style: {background: t.card, borderRadius: '16px', border: '1px solid ' + t.border, overflow: 'hidden'}});
        var imgArea = el('div', {style: {position: 'relative', display: 'flex', height: '200px'}});
        
        var left = el('div', {style: {flex: '1', overflow: 'hidden', position: 'relative', outline: state.activeEdit === 'outfit' ? '3px solid ' + t.accent : 'none', outlineOffset: '-3px', cursor: 'pointer'}, onClick: function() { setState({activeEdit: 'outfit'}); }});
        left.appendChild(el('img', {src: state.np.outfit, style: {width: '100%', height: '100%', objectFit: 'cover', objectPosition: (50 + state.np.outfitX) + '% ' + (50 + state.np.outfitY) + '%'}}));
        
        var right = el('div', {style: {flex: '1', overflow: 'hidden', position: 'relative', outline: state.activeEdit === 'photo' ? '3px solid ' + t.accent : 'none', outlineOffset: '-3px', cursor: 'pointer'}, onClick: function() { setState({activeEdit: 'photo'}); }});
        right.appendChild(el('img', {src: state.np.photo, style: {width: '100%', height: '100%', objectFit: 'cover', objectPosition: (50 + state.np.photoX) + '% ' + (50 + state.np.photoY) + '%'}}));
        
        var font = FONTS[state.np.songFont].v;
        var color = COLORS[state.np.songColor];
        var song = el('div', {style: {position: 'absolute', left: '50%', top: '50%', transform: 'translate(-50%,-50%)', textAlign: 'center', textShadow: '0 2px 8px rgba(0,0,0,.95)', padding: '10px 16px', borderRadius: '8px', background: state.activeEdit === 'song' ? 'rgba(255,255,255,.2)' : 'transparent', border: state.activeEdit === 'song' ? '2px dashed ' + t.accent : 'none', cursor: 'pointer'}, onClick: function() { setState({activeEdit: 'song'}); }});
        song.appendChild(el('p', {style: {margin: '0', fontSize: '15px', fontWeight: '600', color: color, fontFamily: font}}, 'üéµ ' + state.np.songTitle));
        song.appendChild(el('p', {style: {margin: '3px 0 0', fontSize: '12px', color: color, fontFamily: font}}, state.np.songArtist));
        
        imgArea.appendChild(left);
        imgArea.appendChild(el('div', {style: {width: '3px', background: t.card}}));
        imgArea.appendChild(right);
        imgArea.appendChild(song);
        imgArea.appendChild(el('div', {style: {position: 'absolute', top: '10px', left: '50%', transform: 'translateX(-50%)', background: t.accent, color: '#fff', padding: '5px 12px', borderRadius: '6px', fontSize: '10px', fontWeight: '700'}}, 'üìÆ POSTCARD'));
        
        preview.appendChild(imgArea);
        
        var bottom = el('div', {style: {padding: '14px', borderTop: '1px solid ' + t.border}});
        var info = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px'}});
        if (state.userData && state.userData.avatar) {
          info.appendChild(el('img', {src: state.userData.avatar, style: {width: '32px', height: '32px', borderRadius: '10px', objectFit: 'cover'}}));
        } else {
          info.appendChild(el('div', {style: {width: '32px', height: '32px', borderRadius: '10px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '13px', fontWeight: '600', color: '#fff'}}, (state.userData && state.userData.username) ? state.userData.username[0].toUpperCase() : '?'));
        }
        var meta = el('div', {style: {flex: '1'}});
        meta.appendChild(el('p', {style: {margin: '0', fontSize: '13px', fontWeight: '600', color: t.text}}, 'You'));
        meta.appendChild(el('p', {style: {margin: '0', fontSize: '11px', color: t.muted}}, 'üìç ' + (state.np.loc || 'Location') + ' ¬∑ Today'));
        info.appendChild(meta);
        bottom.appendChild(info);
        if (state.np.quote) {
          bottom.appendChild(el('p', {style: {margin: '10px 0 0', fontSize: '14px', fontStyle: 'italic', color: t.text}}, '"' + state.np.quote + '"'));
        }
        preview.appendChild(bottom);
        content.appendChild(preview);
        
        // Controls
        if (!state.activeEdit) {
          var hint = el('div', {style: {padding: '20px', background: t.card, borderRadius: '16px', border: '2px dashed ' + t.border, textAlign: 'center'}});
          hint.appendChild(el('p', {style: {margin: '0', color: t.muted, fontSize: '14px'}}, 'üëÜ Tap an image or song text to edit'));
          content.appendChild(hint);
        } else if (state.activeEdit === 'song') {
          var ctrl = el('div', {style: {background: t.card, borderRadius: '16px', padding: '20px', border: '2px solid ' + t.accent}});
          var hdr = el('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}});
          hdr.appendChild(el('p', {style: {margin: '0', fontSize: '16px', fontWeight: '600', color: t.text}}, 'üéµ Song Style'));
          hdr.appendChild(el('span', {className: 'tap', style: {fontSize: '20px', color: t.muted, padding: '4px'}, onClick: function() { setState({activeEdit: null}); }}, '‚úï'));
          ctrl.appendChild(hdr);
          
          ctrl.appendChild(el('p', {style: {margin: '0 0 10px', fontSize: '13px', fontWeight: '500', color: t.text}}, 'Font'));
          var fonts = el('div', {style: {display: 'flex', gap: '8px', flexWrap: 'wrap', marginBottom: '16px'}});
          for (var i = 0; i < FONTS.length; i++) {
            (function(idx) {
              var f = FONTS[idx];
              fonts.appendChild(el('span', {className: 'tap', style: {padding: '10px 14px', borderRadius: '10px', fontSize: '13px', background: state.np.songFont === idx ? t.accent : t.bg, color: state.np.songFont === idx ? '#fff' : t.text, fontFamily: f.v, fontWeight: '500'}, onClick: function() { setNp({songFont: idx}); }}, f.n));
            })(i);
          }
          ctrl.appendChild(fonts);
          
          ctrl.appendChild(el('p', {style: {margin: '0 0 10px', fontSize: '13px', fontWeight: '500', color: t.text}}, 'Color'));
          var colors = el('div', {style: {display: 'flex', gap: '10px'}});
          for (var i = 0; i < COLORS.length; i++) {
            (function(idx) {
              colors.appendChild(el('span', {className: 'tap', style: {width: '40px', height: '40px', borderRadius: '10px', background: COLORS[idx], border: state.np.songColor === idx ? '3px solid ' + t.accent : '2px solid ' + t.border}, onClick: function() { setNp({songColor: idx}); }}));
            })(i);
          }
          ctrl.appendChild(colors);
          content.appendChild(ctrl);
        } else {
          var isOutfit = state.activeEdit === 'outfit';
          var prefix = isOutfit ? 'outfit' : 'photo';
          
          var ctrl = el('div', {style: {background: t.card, borderRadius: '16px', padding: '20px', border: '2px solid ' + t.accent}});
          var hdr = el('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}});
          hdr.appendChild(el('p', {style: {margin: '0', fontSize: '16px', fontWeight: '600', color: t.text}}, (isOutfit ? 'üëï Outfit' : 'üì∑ Photo') + ' Position'));
          hdr.appendChild(el('span', {className: 'tap', style: {fontSize: '20px', color: t.muted, padding: '4px'}, onClick: function() { setState({activeEdit: null}); }}, '‚úï'));
          ctrl.appendChild(hdr);
          
          var dpad = el('div', {style: {display: 'grid', gridTemplateColumns: 'repeat(3,1fr)', gap: '10px', maxWidth: '200px', margin: '0 auto'}});
          dpad.appendChild(el('div'));
          dpad.appendChild(el('span', {className: 'tap', style: {padding: '18px', background: t.bg, borderRadius: '12px', textAlign: 'center', fontSize: '22px'}, onClick: function() { var u = {}; u[prefix + 'Y'] = state.np[prefix + 'Y'] - 10; setNp(u); }}, '‚Üë'));
          dpad.appendChild(el('div'));
          dpad.appendChild(el('span', {className: 'tap', style: {padding: '18px', background: t.bg, borderRadius: '12px', textAlign: 'center', fontSize: '22px'}, onClick: function() { var u = {}; u[prefix + 'X'] = state.np[prefix + 'X'] - 10; setNp(u); }}, '‚Üê'));
          dpad.appendChild(el('span', {className: 'tap', style: {padding: '18px', background: t.accent, borderRadius: '12px', textAlign: 'center', fontSize: '11px', fontWeight: '600', color: '#fff', display: 'flex', alignItems: 'center', justifyContent: 'center'}, onClick: function() { var u = {}; u[prefix + 'X'] = 0; u[prefix + 'Y'] = 0; setNp(u); }}, 'Reset'));
          dpad.appendChild(el('span', {className: 'tap', style: {padding: '18px', background: t.bg, borderRadius: '12px', textAlign: 'center', fontSize: '22px'}, onClick: function() { var u = {}; u[prefix + 'X'] = state.np[prefix + 'X'] + 10; setNp(u); }}, '‚Üí'));
          dpad.appendChild(el('div'));
          dpad.appendChild(el('span', {className: 'tap', style: {padding: '18px', background: t.bg, borderRadius: '12px', textAlign: 'center', fontSize: '22px'}, onClick: function() { var u = {}; u[prefix + 'Y'] = state.np[prefix + 'Y'] + 10; setNp(u); }}, '‚Üì'));
          dpad.appendChild(el('div'));
          ctrl.appendChild(dpad);
          content.appendChild(ctrl);
        }
        
        var btns = el('div', {style: {display: 'flex', gap: '12px'}});
        btns.appendChild(el('span', {className: 'tap', style: {padding: '16px 24px', border: '1px solid ' + t.border, borderRadius: '14px', fontSize: '15px', color: t.text, background: t.card}, onClick: function() { setState({step: 2}); }}, '‚Üê'));
        btns.appendChild(el('span', {className: 'tap', style: {flex: '1', color: '#fff', padding: '18px', borderRadius: '14px', fontSize: '16px', fontWeight: '600', textAlign: 'center', background: t.accent}, onClick: function() { setState({activeEdit: null, step: 4}); }}, 'Preview ‚Üí'));
        content.appendChild(btns);
        
        page.appendChild(content);
      }
      
      // Step 4: Preview
      if (state.step === 4) {
        var content = el('div', {style: {display: 'flex', flexDirection: 'column', gap: '20px'}});
        content.appendChild(el('p', {style: {color: t.text, textAlign: 'center', margin: '0', fontSize: '16px', fontWeight: '500'}}, 'Ready to send? üéâ'));
        
        var previewPost = {
          outfit: state.np.outfit,
          photo: state.np.photo,
          outfitPhoto: state.np.outfit,
          outfitX: state.np.outfitX,
          outfitY: state.np.outfitY,
          photoX: state.np.photoX,
          photoY: state.np.photoY,
          song: {title: state.np.songTitle, artist: state.np.songArtist},
          songFont: state.np.songFont,
          songColor: state.np.songColor,
          location: state.np.loc,
          quote: state.np.quote,
          privateNote: state.np.privateNote,
          date: 'Today'
        };
        content.appendChild(postcardEl(previewPost, state.userData, {showPrivate: true, showStamp: true}));
        
        var btns = el('div', {style: {display: 'flex', gap: '12px'}});
        btns.appendChild(el('span', {className: 'tap', style: {padding: '16px 24px', border: '1px solid ' + t.border, borderRadius: '14px', fontSize: '15px', color: t.text, background: t.card}, onClick: function() { setState({step: 3}); }}, '‚Üê Edit'));
        btns.appendChild(el('span', {className: 'tap', style: {flex: '1', color: '#fff', padding: '18px', borderRadius: '14px', fontSize: '16px', fontWeight: '600', textAlign: 'center', background: t.accent, opacity: state.uploading ? '0.5' : '1'}, onClick: submit}, state.uploading ? 'Sending...' : 'Send ‚úàÔ∏è'));
        content.appendChild(btns);
        
        page.appendChild(content);
      }
      
      app.appendChild(page);
      return;
    }
    
    // Settings
    if (state.view === 'settings') {
      var page = el('div', {style: {minHeight: '100vh', padding: '0 20px 40px'}});
      var header = el('header', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 0'}});
      header.appendChild(el('span', {className: 'tap', style: {fontSize: '28px', padding: '8px 12px', color: t.text}, onClick: function() { nav('feed'); }}, '‚Üê'));
      header.appendChild(el('span', {style: {fontWeight: '600', color: t.text}}, 'Settings'));
      header.appendChild(el('div', {style: {width: '48px'}}));
      page.appendChild(header);
      
      // Profile Section
      var profileSection = el('div', {style: {padding: '16px', borderRadius: '16px', border: '1px solid ' + t.border, background: t.card, marginBottom: '12px'}});
      profileSection.appendChild(el('p', {style: {margin: '0 0 16px', fontSize: '14px', fontWeight: '600', color: t.text}}, 'üë§ Profile'));
      
      if (state.editingProfile) {
        // Editing mode
        var avatarWrap = el('div', {style: {display: 'flex', justifyContent: 'center', marginBottom: '16px'}});
        var avatarInput = el('input', {type: 'file', accept: 'image/*', style: {display: 'none'}, id: 'editAvatarInput'});
        avatarInput.onchange = function(e) {
          var f = e.target.files[0];
          if (f) {
            var r = new FileReader();
            r.onloadend = function() {
              state.editProfile.newAvatar = r.result;
              render();
            };
            r.readAsDataURL(f);
          }
        };
        var avatarLabel = el('label', {className: 'tap', for: 'editAvatarInput', style: {position: 'relative'}});
        var avatarSrc = state.editProfile.newAvatar || state.editProfile.avatar;
        if (avatarSrc) {
          avatarLabel.appendChild(el('img', {src: avatarSrc, style: {width: '80px', height: '80px', borderRadius: '24px', objectFit: 'cover'}}));
        } else {
          avatarLabel.appendChild(el('div', {style: {width: '80px', height: '80px', borderRadius: '24px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', fontWeight: '700', color: '#fff'}}, state.editProfile.username ? state.editProfile.username[0].toUpperCase() : '?'));
        }
        avatarLabel.appendChild(el('div', {style: {position: 'absolute', bottom: '-4px', right: '-4px', width: '28px', height: '28px', borderRadius: '50%', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', border: '2px solid ' + t.card}}, 'üì∑'));
        avatarWrap.appendChild(avatarInput);
        avatarWrap.appendChild(avatarLabel);
        profileSection.appendChild(avatarWrap);
        
        // Username field
        var usernameField = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px', padding: '14px', borderRadius: '14px', border: '1px solid ' + t.border, background: t.bg, marginBottom: '12px'}});
        usernameField.appendChild(el('span', null, 'üë§'));
        var usernameInput = el('input', {placeholder: 'Username', value: state.editProfile.username, style: {flex: '1', background: 'transparent', border: 'none', fontSize: '15px', color: t.text, outline: 'none'}});
        usernameInput.oninput = function(e) { state.editProfile.username = e.target.value; };
        usernameField.appendChild(usernameInput);
        profileSection.appendChild(usernameField);
        
        // Email (read-only)
        var emailField = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px', padding: '14px', borderRadius: '14px', border: '1px solid ' + t.border, background: t.bg, marginBottom: '12px', opacity: '0.6'}});
        emailField.appendChild(el('span', null, '‚úâÔ∏è'));
        emailField.appendChild(el('span', {style: {flex: '1', fontSize: '15px', color: t.muted}}, state.user ? state.user.email : ''));
        profileSection.appendChild(emailField);
        profileSection.appendChild(el('p', {style: {margin: '-8px 0 12px', fontSize: '11px', color: t.muted, textAlign: 'center'}}, 'Email cannot be changed'));
        
        // Save/Cancel buttons
        var editBtns = el('div', {style: {display: 'flex', gap: '8px'}});
        editBtns.appendChild(el('span', {className: 'tap', style: {flex: '1', padding: '12px', borderRadius: '10px', border: '1px solid ' + t.border, textAlign: 'center', fontSize: '14px', color: t.text, background: t.card}, onClick: cancelEditProfile}, 'Cancel'));
        editBtns.appendChild(el('span', {className: 'tap', style: {flex: '1', padding: '12px', borderRadius: '10px', textAlign: 'center', fontSize: '14px', fontWeight: '600', color: '#fff', background: t.accent, opacity: state.savingProfile ? '0.5' : '1'}, onClick: state.savingProfile ? null : saveProfile}, state.savingProfile ? 'Saving...' : 'Save'));
        profileSection.appendChild(editBtns);
      } else {
        // View mode
        var profileRow = el('div', {style: {display: 'flex', alignItems: 'center', gap: '12px'}});
        if (state.userData && state.userData.avatar) {
          profileRow.appendChild(el('img', {src: state.userData.avatar, style: {width: '50px', height: '50px', borderRadius: '16px', objectFit: 'cover'}}));
        } else {
          profileRow.appendChild(el('div', {style: {width: '50px', height: '50px', borderRadius: '16px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', fontWeight: '600', color: '#fff'}}, (state.userData && state.userData.username) ? state.userData.username[0].toUpperCase() : '?'));
        }
        var profileInfo = el('div', {style: {flex: '1'}});
        profileInfo.appendChild(el('p', {style: {margin: '0', fontSize: '16px', fontWeight: '600', color: t.text}}, state.userData ? state.userData.username : 'User'));
        profileInfo.appendChild(el('p', {style: {margin: '2px 0 0', fontSize: '13px', color: t.muted}}, state.user ? state.user.email : ''));
        profileRow.appendChild(profileInfo);
        profileRow.appendChild(el('span', {className: 'tap', style: {padding: '10px 16px', borderRadius: '10px', background: t.bg, fontSize: '13px', fontWeight: '600', color: t.accent}, onClick: startEditProfile}, 'Edit'));
        profileSection.appendChild(profileRow);
      }
      page.appendChild(profileSection);
      
      // Dark mode toggle
      var darkToggle = el('div', {style: {display: 'flex', alignItems: 'center', justifyContent: 'space-between', padding: '16px', borderRadius: '16px', border: '1px solid ' + t.border, background: t.card, marginBottom: '12px'}});
      var darkInfo = el('div', {style: {display: 'flex', alignItems: 'center', gap: '12px'}});
      darkInfo.appendChild(el('span', {style: {fontSize: '24px'}}, state.dark ? 'üåô' : '‚òÄÔ∏è'));
      darkInfo.appendChild(el('span', {style: {fontWeight: '600', color: t.text}}, (state.dark ? 'Dark' : 'Light') + ' mode'));
      var toggle = el('span', {className: 'tap', style: {width: '50px', height: '30px', borderRadius: '15px', padding: '3px', background: state.dark ? t.accent : t.border, display: 'block'}, onClick: function() { setState({dark: !state.dark}); }});
      toggle.appendChild(el('div', {style: {width: '24px', height: '24px', borderRadius: '12px', background: '#fff', transform: state.dark ? 'translateX(20px)' : 'translateX(0)', transition: 'transform .3s'}}));
      darkToggle.appendChild(darkInfo);
      darkToggle.appendChild(toggle);
      page.appendChild(darkToggle);
      
      // Log out button
      page.appendChild(el('span', {className: 'tap', style: {display: 'block', padding: '16px', borderRadius: '16px', border: '1px solid ' + t.border, background: t.card, textAlign: 'center', color: '#e53935', fontWeight: '600', marginTop: '20px'}, onClick: handleLogout}, 'Log Out'));
      app.appendChild(page);
      return;
    }
    
    // Profile
    if (state.view === 'profile') {
      var page = el('div', {style: {minHeight: '100vh', padding: '0 20px 40px'}});
      var header = el('header', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 0'}});
      header.appendChild(el('span', {className: 'tap', style: {fontSize: '28px', padding: '8px 12px', color: t.text}, onClick: function() { nav('feed'); }}, '‚Üê'));
      header.appendChild(el('span', {style: {fontWeight: '600', color: t.text}}, 'Profile'));
      header.appendChild(el('div', {style: {width: '48px'}}));
      page.appendChild(header);
      
      var info = el('div', {style: {display: 'flex', flexDirection: 'column', alignItems: 'center', paddingTop: '10px'}});
      if (state.userData && state.userData.avatar) {
        info.appendChild(el('img', {src: state.userData.avatar, style: {width: '80px', height: '80px', borderRadius: '24px', objectFit: 'cover', marginBottom: '12px'}}));
      } else {
        info.appendChild(el('div', {style: {width: '80px', height: '80px', borderRadius: '24px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', fontWeight: '700', color: '#fff', marginBottom: '12px'}}, (state.userData && state.userData.username) ? state.userData.username[0].toUpperCase() : '?'));
      }
      info.appendChild(el('h2', {style: {margin: '0 0 4px', fontSize: '22px', fontWeight: '600', color: t.text}}, state.userData ? state.userData.username : 'User'));
      
      var stats = el('div', {style: {display: 'flex', gap: '24px', padding: '20px', borderRadius: '16px', border: '1px solid ' + t.border, width: '100%', background: t.card, marginTop: '20px', marginBottom: '20px'}});
      var stat1 = el('div', {style: {flex: '1', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px'}});
      stat1.appendChild(el('span', {style: {fontSize: '24px', fontWeight: '700', color: t.text}}, state.myPosts.length));
      stat1.appendChild(el('span', {style: {fontSize: '13px', color: t.muted}}, 'Postcards'));
      var stat2 = el('div', {style: {flex: '1', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px'}});
      stat2.appendChild(el('span', {style: {fontSize: '24px', fontWeight: '700', color: t.text}}, state.friends.length));
      stat2.appendChild(el('span', {style: {fontSize: '13px', color: t.muted}}, 'Friends'));
      stats.appendChild(stat1);
      stats.appendChild(stat2);
      info.appendChild(stats);
      
      // Friend Requests
      if (state.friendRequests.length > 0) {
        var reqSection = el('div', {style: {width: '100%', marginBottom: '20px', padding: '16px', borderRadius: '16px', background: '#fff8e1', border: '1px solid #ffcc80'}});
        reqSection.appendChild(el('p', {style: {margin: '0 0 12px', fontSize: '14px', fontWeight: '600', color: '#e65100'}}, 'üëã Friend Requests (' + state.friendRequests.length + ')'));
        
        for (var i = 0; i < state.friendRequests.length; i++) {
          (function(req) {
            var reqItem = el('div', {style: {display: 'flex', alignItems: 'center', gap: '10px', padding: '12px', borderRadius: '12px', background: '#fff', marginBottom: i < state.friendRequests.length - 1 ? '8px' : '0'}});
            
            if (req.fromUser && req.fromUser.avatar) {
              reqItem.appendChild(el('img', {src: req.fromUser.avatar, style: {width: '40px', height: '40px', borderRadius: '12px', objectFit: 'cover'}}));
            } else {
              reqItem.appendChild(el('div', {style: {width: '40px', height: '40px', borderRadius: '12px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px', fontWeight: '600', color: '#fff'}}, (req.fromUser && req.fromUser.username) ? req.fromUser.username[0].toUpperCase() : '?'));
            }
            
            var reqInfo = el('div', {style: {flex: '1'}});
            reqInfo.appendChild(el('p', {style: {margin: '0', fontSize: '14px', fontWeight: '600', color: t.text}}, req.fromUser ? req.fromUser.username : 'Someone'));
            reqInfo.appendChild(el('p', {style: {margin: '2px 0 0', fontSize: '11px', color: t.muted}}, 'wants to be friends'));
            reqItem.appendChild(reqInfo);
            
            var reqBtns = el('div', {style: {display: 'flex', gap: '6px'}});
            reqBtns.appendChild(el('span', {className: 'tap', style: {padding: '8px 12px', borderRadius: '8px', background: t.accent, color: '#fff', fontSize: '12px', fontWeight: '600'}, onClick: function() { acceptFriendRequest(req); }}, '‚úì'));
            reqBtns.appendChild(el('span', {className: 'tap', style: {padding: '8px 12px', borderRadius: '8px', background: t.border, color: t.muted, fontSize: '12px', fontWeight: '600'}, onClick: function() { declineFriendRequest(req); }}, '‚úï'));
            reqItem.appendChild(reqBtns);
            
            reqSection.appendChild(reqItem);
          })(state.friendRequests[i]);
        }
        info.appendChild(reqSection);
      }
      
      // Add friend
      var addWrap = el('div', {style: {width: '100%', marginBottom: '20px'}});
      addWrap.appendChild(el('span', {className: 'tap', style: {display: 'flex', alignItems: 'center', justifyContent: 'center', gap: '8px', padding: '14px', borderRadius: '14px', background: t.accent, color: '#fff', fontWeight: '600', fontSize: '14px'}, onClick: function() { setState({showAddFriend: !state.showAddFriend}); }}, state.showAddFriend ? '‚úï Close' : 'üë• Add Friends'));
      if (state.showAddFriend) {
        var addBox = el('div', {style: {marginTop: '12px', padding: '16px', borderRadius: '16px', border: '1px solid ' + t.border, background: t.card}});
        addBox.appendChild(el('p', {style: {margin: '0 0 8px', fontSize: '13px', fontWeight: '600', color: t.text}}, 'Add by username:'));
        var addRow = el('div', {style: {display: 'flex', gap: '8px'}});
        var addInput = el('input', {placeholder: 'Username', value: state.friendCode, style: {flex: '1', padding: '12px', borderRadius: '10px', border: '1px solid ' + t.border, background: t.bg, fontSize: '14px', color: t.text, outline: 'none'}});
        addInput.oninput = function(e) { state.friendCode = e.target.value; };
        addRow.appendChild(addInput);
        addRow.appendChild(el('span', {className: 'tap', style: {padding: '12px 16px', borderRadius: '10px', background: t.accent, color: '#fff', fontSize: '14px', fontWeight: '600'}, onClick: addFriend}, 'Add'));
        addBox.appendChild(addRow);
        addWrap.appendChild(addBox);
      }
      info.appendChild(addWrap);
      
      // Friends List
      if (state.friends.length > 0) {
        var friendsSection = el('div', {style: {width: '100%', marginBottom: '20px', padding: '16px', borderRadius: '16px', border: '1px solid ' + t.border, background: t.card}});
        friendsSection.appendChild(el('p', {style: {margin: '0 0 12px', fontSize: '14px', fontWeight: '600', color: t.text}}, 'üë• Friends (' + state.friends.length + ')'));
        
        for (var i = 0; i < state.friends.length; i++) {
          (function(friend) {
            var friendItem = el('div', {className: 'tap', style: {display: 'flex', alignItems: 'center', gap: '10px', padding: '12px', borderRadius: '12px', background: t.bg, marginBottom: i < state.friends.length - 1 ? '8px' : '0'}, onClick: function() { setState({friendProfile: friend, friendCalDate: new Date(), view: 'friendProfile'}); }});
            
            if (friend.avatar) {
              friendItem.appendChild(el('img', {src: friend.avatar, style: {width: '44px', height: '44px', borderRadius: '14px', objectFit: 'cover'}}));
            } else {
              friendItem.appendChild(el('div', {style: {width: '44px', height: '44px', borderRadius: '14px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '16px', fontWeight: '600', color: '#fff'}}, friend.username ? friend.username[0].toUpperCase() : '?'));
            }
            
            var friendInfo = el('div', {style: {flex: '1'}});
            friendInfo.appendChild(el('p', {style: {margin: '0', fontSize: '15px', fontWeight: '600', color: t.text}}, friend.username || 'Friend'));
            if (friend.birthday) {
              var bParts = friend.birthday.split('-');
              var bDate = new Date(bParts[0], bParts[1] - 1, bParts[2]);
              friendInfo.appendChild(el('p', {style: {margin: '2px 0 0', fontSize: '12px', color: t.muted}}, 'üéÇ ' + bDate.toLocaleDateString('en-US', {month: 'short', day: 'numeric'})));
            }
            friendItem.appendChild(friendInfo);
            
            friendItem.appendChild(el('span', {style: {fontSize: '18px', color: t.muted}}, '‚Üí'));
            
            friendsSection.appendChild(friendItem);
          })(state.friends[i]);
        }
        info.appendChild(friendsSection);
      }
      
      // Calendar
      var cal = el('div', {style: {width: '100%', borderRadius: '16px', border: '1px solid ' + t.border, padding: '16px', background: t.card}});
      cal.appendChild(el('p', {style: {margin: '0 0 12px', fontSize: '14px', fontWeight: '600', color: t.text}}, 'Your Postcards'));
      
      var calNav = el('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}});
      calNav.appendChild(el('span', {className: 'tap', style: {fontSize: '24px', padding: '4px 12px', color: t.text}, onClick: function() { setState({calDate: new Date(state.calDate.getFullYear(), state.calDate.getMonth() - 1, 1)}); }}, '‚Äπ'));
      calNav.appendChild(el('span', {style: {fontWeight: '600', color: t.text}}, fmtMonth(state.calDate)));
      calNav.appendChild(el('span', {className: 'tap', style: {fontSize: '24px', padding: '4px 12px', color: t.text}, onClick: function() { setState({calDate: new Date(state.calDate.getFullYear(), state.calDate.getMonth() + 1, 1)}); }}, '‚Ä∫'));
      cal.appendChild(calNav);
      
      var dayHeaders = el('div', {style: {display: 'grid', gridTemplateColumns: 'repeat(7,1fr)', marginBottom: '8px'}});
      var dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      for (var i = 0; i < 7; i++) {
        dayHeaders.appendChild(el('div', {style: {textAlign: 'center', fontSize: '12px', fontWeight: '600', padding: '8px', color: t.muted}}, dayNames[i]));
      }
      cal.appendChild(dayHeaders);
      
      var days = el('div', {style: {display: 'grid', gridTemplateColumns: 'repeat(7,1fr)', gap: '4px'}});
      var startDay = getStartDay(state.calDate);
      var daysInMonth = getDaysInMonth(state.calDate);
      var now = new Date();
      var isCurrent = state.calDate.getMonth() === now.getMonth() && state.calDate.getFullYear() === now.getFullYear();
      
      for (var i = 0; i < startDay; i++) {
        days.appendChild(el('div'));
      }
      for (var day = 1; day <= daysInMonth; day++) {
        (function(d) {
          var post = getPostForDate(d);
          var isToday = isCurrent && d === now.getDate();
          var birthdays = getBirthdaysForDate(state.calDate.getMonth() + 1, d);
          var hasBirthday = birthdays.length > 0;
          var cellBg = post ? t.accent : (hasBirthday ? '#fff3e0' : 'transparent');
          var cell = el('div', {className: post ? 'tap' : '', style: {aspectRatio: '1', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '10px', background: cellBg, color: post ? '#fff' : t.text, border: isToday ? '2px solid ' + t.accent : 'none', fontWeight: isToday ? '700' : '400', flexDirection: 'column', position: 'relative'}});
          if (post) {
            cell.appendChild(el('span', {style: {fontSize: '10px'}}, d));
            cell.appendChild(el('span', {style: {fontSize: '8px'}}, 'üìÆ'));
            cell.onclick = function() { setState({dayPost: post, view: 'dayDetail'}); };
          } else {
            cell.appendChild(el('span', {style: {fontSize: '12px'}}, d));
          }
          if (hasBirthday && !post) {
            cell.appendChild(el('span', {style: {fontSize: '8px', position: 'absolute', bottom: '2px'}}, 'üéÇ'));
          }
          days.appendChild(cell);
        })(day);
      }
      cal.appendChild(days);
      info.appendChild(cal);
      
      page.appendChild(info);
      app.appendChild(page);
      return;
    }
    
    // Friend Profile view
    if (state.view === 'friendProfile' && state.friendProfile) {
      var friend = state.friendProfile;
      var page = el('div', {style: {minHeight: '100vh', padding: '0 20px 40px'}});
      
      var header = el('header', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '16px 0'}});
      header.appendChild(el('span', {className: 'tap', style: {fontSize: '28px', padding: '8px 12px', color: t.text}, onClick: function() { nav('profile'); }}, '‚Üê'));
      header.appendChild(el('span', {style: {fontWeight: '600', color: t.text}}, friend.username || 'Friend'));
      header.appendChild(el('div', {style: {width: '48px'}}));
      page.appendChild(header);
      
      var info = el('div', {style: {display: 'flex', flexDirection: 'column', alignItems: 'center', paddingTop: '10px'}});
      
      if (friend.avatar) {
        info.appendChild(el('img', {src: friend.avatar, style: {width: '80px', height: '80px', borderRadius: '24px', objectFit: 'cover', marginBottom: '12px'}}));
      } else {
        info.appendChild(el('div', {style: {width: '80px', height: '80px', borderRadius: '24px', background: t.accent, display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', fontWeight: '700', color: '#fff', marginBottom: '12px'}}, friend.username ? friend.username[0].toUpperCase() : '?'));
      }
      
      info.appendChild(el('h2', {style: {margin: '0 0 4px', fontSize: '22px', fontWeight: '600', color: t.text}}, friend.username || 'Friend'));
      
      if (friend.birthday) {
        var bParts = friend.birthday.split('-');
        var bDate = new Date(bParts[0], bParts[1] - 1, bParts[2]);
        info.appendChild(el('p', {style: {margin: '0 0 16px', fontSize: '14px', color: t.muted}}, 'üéÇ ' + bDate.toLocaleDateString('en-US', {month: 'long', day: 'numeric'})));
      }
      
      var stats = el('div', {style: {display: 'flex', gap: '24px', padding: '20px', borderRadius: '16px', border: '1px solid ' + t.border, width: '100%', background: t.card, marginBottom: '20px'}});
      var stat1 = el('div', {style: {flex: '1', display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '4px'}});
      stat1.appendChild(el('span', {style: {fontSize: '24px', fontWeight: '700', color: t.text}}, friend.posts ? friend.posts.length : 0));
      stat1.appendChild(el('span', {style: {fontSize: '13px', color: t.muted}}, 'Postcards'));
      stats.appendChild(stat1);
      info.appendChild(stats);
      
      // Friend's Calendar
      var cal = el('div', {style: {width: '100%', borderRadius: '16px', border: '1px solid ' + t.border, padding: '16px', background: t.card}});
      cal.appendChild(el('p', {style: {margin: '0 0 12px', fontSize: '14px', fontWeight: '600', color: t.text}}, friend.username + "'s Postcards"));
      
      var calNav = el('div', {style: {display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px'}});
      calNav.appendChild(el('span', {className: 'tap', style: {fontSize: '24px', padding: '4px 12px', color: t.text}, onClick: function() { setState({friendCalDate: new Date(state.friendCalDate.getFullYear(), state.friendCalDate.getMonth() - 1, 1)}); }}, '‚Äπ'));
      calNav.appendChild(el('span', {style: {fontWeight: '600', color: t.text}}, fmtMonth(state.friendCalDate)));
      calNav.appendChild(el('span', {className: 'tap', style: {fontSize: '24px', padding: '4px 12px', color: t.text}, onClick: function() { setState({friendCalDate: new Date(state.friendCalDate.getFullYear(), state.friendCalDate.getMonth() + 1, 1)}); }}, '‚Ä∫'));
      cal.appendChild(calNav);
      
      var dayHeaders = el('div', {style: {display: 'grid', gridTemplateColumns: 'repeat(7,1fr)', marginBottom: '8px'}});
      var dayNames = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
      for (var i = 0; i < 7; i++) {
        dayHeaders.appendChild(el('div', {style: {textAlign: 'center', fontSize: '12px', fontWeight: '600', padding: '8px', color: t.muted}}, dayNames[i]));
      }
      cal.appendChild(dayHeaders);
      
      var days = el('div', {style: {display: 'grid', gridTemplateColumns: 'repeat(7,1fr)', gap: '4px'}});
      var startDay = getStartDay(state.friendCalDate);
      var daysInMonth = getDaysInMonth(state.friendCalDate);
      var now = new Date();
      var isCurrent = state.friendCalDate.getMonth() === now.getMonth() && state.friendCalDate.getFullYear() === now.getFullYear();
      
      for (var i = 0; i < startDay; i++) {
        days.appendChild(el('div'));
      }
      for (var day = 1; day <= daysInMonth; day++) {
        (function(d) {
          // Find friend's post for this date
          var month = String(state.friendCalDate.getMonth() + 1);
          if (month.length < 2) month = '0' + month;
          var dayStr = String(d);
          if (dayStr.length < 2) dayStr = '0' + dayStr;
          var ds = state.friendCalDate.getFullYear() + '-' + month + '-' + dayStr;
          var post = null;
          if (friend.posts) {
            for (var j = 0; j < friend.posts.length; j++) {
              if (friend.posts[j].date === ds) {
                post = friend.posts[j];
                break;
              }
            }
          }
          
          var isToday = isCurrent && d === now.getDate();
          var cell = el('div', {className: post ? 'tap' : '', style: {aspectRatio: '1', display: 'flex', alignItems: 'center', justifyContent: 'center', borderRadius: '10px', background: post ? t.accent : 'transparent', color: post ? '#fff' : t.text, border: isToday ? '2px solid ' + t.accent : 'none', fontWeight: isToday ? '700' : '400', flexDirection: 'column'}});
          if (post) {
            cell.appendChild(el('span', {style: {fontSize: '10px'}}, d));
            cell.appendChild(el('span', {style: {fontSize: '8px'}}, 'üìÆ'));
            cell.onclick = function() { setState({friendDayPost: post, view: 'friendDayDetail'}); };
          } else {
            cell.appendChild(el('span', {style: {fontSize: '12px'}}, d));
          }
          days.appendChild(cell);
        })(day);
      }
      cal.appendChild(days);
      info.appendChild(cal);
      
      // Unfriend button
      var unfriendBtn = el('span', {className: 'tap', style: {display: 'block', width: '100%', marginTop: '20px', padding: '14px', borderRadius: '14px', border: '1px solid #ffcdd2', background: '#ffebee', textAlign: 'center', color: '#e53935', fontSize: '14px', fontWeight: '600'}, onClick: function() { unfriend(friend.id); }}, 'üëã Remove Friend');
      info.appendChild(unfriendBtn);
      
      page.appendChild(info);
      app.appendChild(page);
      return;
    }
    
    // Friend Day Detail view
    if (state.view === 'friendDayDetail' && state.friendDayPost) {
      var page = el('div', {style: {minHeight: '100vh', padding: '16px'}});
      page.appendChild(el('span', {className: 'tap', style: {position: 'absolute', top: '16px', right: '16px', width: '36px', height: '36px', borderRadius: '12px', fontSize: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: t.card, color: t.text, zIndex: '10'}, onClick: function() { setState({view: 'friendProfile', friendDayPost: null}); }}, '‚úï'));
      var wrap = el('div', {style: {paddingTop: '40px'}});
      wrap.appendChild(postcardEl(state.friendDayPost, state.friendProfile, {showPrivate: false, isOwner: false, showMenu: false, showStamp: true}));
      page.appendChild(wrap);
      app.appendChild(page);
      return;
    }
    
    // Day detail
    if (state.view === 'dayDetail' && state.dayPost) {
      var page = el('div', {style: {minHeight: '100vh', padding: '16px'}});
      page.appendChild(el('span', {className: 'tap', style: {position: 'absolute', top: '16px', right: '16px', width: '36px', height: '36px', borderRadius: '12px', fontSize: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center', background: t.card, color: t.text, zIndex: '10'}, onClick: function() { setState({view: 'profile', dayPost: null, showMenu: false}); }}, '‚úï'));
      var wrap = el('div', {style: {paddingTop: '40px'}});
      var owner = {};
      for (var k in state.userData) owner[k] = state.userData[k];
      owner.id = state.user ? state.user.uid : null;
      wrap.appendChild(postcardEl(state.dayPost, owner, {showPrivate: true, isOwner: true, showMenu: true, showStamp: true}));
      page.appendChild(wrap);
      app.appendChild(page);
      return;
    }
    
    // Default
    app.appendChild(el('div', {style: {padding: '40px', textAlign: 'center'}}, el('p', {style: {color: t.muted}}, 'View: ' + state.view)));
  }

  render();
})();
</script>
</body>
</html>
