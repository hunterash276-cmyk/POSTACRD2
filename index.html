<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Postcard">
  <meta name="theme-color" content="#E07A5F">
  <title>Postcard</title>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-storage-compat.js"></script>
  <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Dancing+Script:wght@400;600&family=Bebas+Neue&family=Courier+Prime&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none}
    html,body,#root{margin:0;padding:0;width:100%;min-height:100vh;min-height:-webkit-fill-available;font-family:-apple-system,BlinkMacSystemFont,sans-serif;overscroll-behavior:none}
    input{-webkit-user-select:text;user-select:text}
    .tap{cursor:pointer;transition:transform .1s,opacity .1s}.tap:active{opacity:.7;transform:scale(.97)}
    .loading{opacity:.5;pointer-events:none}
  </style>
</head>
<body>
<div id="root"></div>
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCVCSTiYb0oj-qiWrQA6PNJw3L1LcQcN2k",
    authDomain: "postcard-d055d.firebaseapp.com",
    projectId: "postcard-d055d",
    storageBucket: "postcard-d055d.firebasestorage.app",
    messagingSenderId: "241151731606",
    appId: "1:241151731606:web:1cac2069b350b1543a1fb7"
  };
  firebase.initializeApp(firebaseConfig);
  window.db = firebase.firestore();
  window.auth = firebase.auth();
  window.storage = firebase.storage();
</script>
<script type="text/babel">
const{useState,useEffect,useRef}=React;
const L={bg:'#FFF9F5',card:'#FFF',text:'#2D2A26',muted:'#8B8680',border:'#E8E4DF',accent:'#E07A5F'};
const D={bg:'#1A1918',card:'#252422',text:'#F5F2EE',muted:'#8B8680',border:'#3D3A36',accent:'#E07A5F'};

const FONTS=[
  {name:'Classic',value:'-apple-system,sans-serif'},
  {name:'Elegant',value:'"Playfair Display",serif'},
  {name:'Script',value:'"Dancing Script",cursive'},
  {name:'Bold',value:'"Bebas Neue",sans-serif'},
  {name:'Mono',value:'"Courier Prime",monospace'}
];
const COLORS=['#FFFFFF','#2D2A26','#E07A5F','#81B29A','#F2CC8F','#3D405B'];

function App(){
  const[dark,setDark]=useState(false);
  const[user,setUser]=useState(null);
  const[userData,setUserData]=useState(null);
  const[view,setView]=useState('loading');
  const[authMode,setAuthMode]=useState('login');
  const[authData,setAuthData]=useState({email:'',password:'',username:'',birthday:'',avatar:null});
  const[authError,setAuthError]=useState('');
  const[authLoading,setAuthLoading]=useState(false);
  const[friends,setFriends]=useState([]);
  const[myPosts,setMyPosts]=useState([]);
  const[posted,setPosted]=useState(false);
  const[sel,setSel]=useState(null);
  const[step,setStep]=useState(1);
  const[np,setNp]=useState({
    photo:null,outfit:null,songTitle:'',songArtist:'',loc:'',quote:'',privateNote:'',
    outfitX:0,outfitY:0,photoX:0,photoY:0,
    songFont:0,songColor:0
  });
  const[uploading,setUploading]=useState(false);
  const[calDate,setCalDate]=useState(new Date());
  const[dayPost,setDayPost]=useState(null);
  const[scrolled,setScrolled]=useState(false);
  const[friendProfile,setFriendProfile]=useState(null);
  const[friendCalDate,setFriendCalDate]=useState(new Date());
  const[friendDayPost,setFriendDayPost]=useState(null);
  const[showAddFriend,setShowAddFriend]=useState(false);
  const[friendCode,setFriendCode]=useState('');
  const[linkCopied,setLinkCopied]=useState(false);
  const[editingProfile,setEditingProfile]=useState(false);
  const[editUsername,setEditUsername]=useState('');
  const[editAvatar,setEditAvatar]=useState(null);
  const[savingProfile,setSavingProfile]=useState(false);
  const[activeEdit,setActiveEdit]=useState(null);
  const[showMenu,setShowMenu]=useState(false);
  const[saving,setSaving]=useState(false);
  const scrollRef=useRef(null);
  const postcardRef=useRef(null);
  const t=dark?D:L;

  useEffect(()=>{
    const unsub=window.auth.onAuthStateChanged(async(u)=>{
      if(u){setUser(u);await loadUserData(u.uid);setView('feed');}
      else{setUser(null);setUserData(null);setView('auth');}
    });
    return()=>unsub();
  },[]);

  const loadUserData=async(uid)=>{
    try{
      const doc=await window.db.collection('users').doc(uid).get();
      if(doc.exists){setUserData({id:uid,...doc.data()});await loadPosts(uid);await loadFriends(uid);}
    }catch(e){console.error(e);}
  };

  const loadPosts=async(uid)=>{
    try{
      const snap=await window.db.collection('posts').where('userId','==',uid).orderBy('date','desc').get();
      const posts=snap.docs.map(d=>({id:d.id,...d.data()}));
      setMyPosts(posts);
      setPosted(posts.some(p=>p.date===new Date().toISOString().split('T')[0]));
    }catch(e){console.error(e);}
  };

  const loadFriends=async(uid)=>{
    try{
      const userDoc=await window.db.collection('users').doc(uid).get();
      const friendIds=userDoc.data()?.friends||[];
      const friendsData=[];
      for(const fid of friendIds){
        const fDoc=await window.db.collection('users').doc(fid).get();
        if(fDoc.exists){
          const fData={id:fid,...fDoc.data()};
          const pSnap=await window.db.collection('posts').where('userId','==',fid).orderBy('date','desc').get();
          fData.posts=pSnap.docs.map(d=>({id:d.id,...d.data()}));
          friendsData.push(fData);
        }
      }
      setFriends(friendsData);
    }catch(e){console.error(e);}
  };

  useEffect(()=>{const el=scrollRef.current;if(!el)return;const h=()=>setScrolled(el.scrollTop>50);el.addEventListener('scroll',h);return()=>el.removeEventListener('scroll',h);},[view]);

  const nav=(v)=>{setView(v);setSel(null);setDayPost(null);setFriendProfile(null);setFriendDayPost(null);setShowAddFriend(false);setEditingProfile(false);setAuthError('');setShowMenu(false);setActiveEdit(null);};

  const handleSignup=async()=>{
    if(!authData.email||!authData.password||!authData.username||!authData.birthday){setAuthError('Please fill in all fields');return;}
    setAuthLoading(true);setAuthError('');
    try{
      const cred=await window.auth.createUserWithEmailAndPassword(authData.email,authData.password);
      let avatarUrl=null;
      if(authData.avatar){
        const ref=window.storage.ref(`avatars/${cred.user.uid}`);
        await ref.putString(authData.avatar,'data_url');
        avatarUrl=await ref.getDownloadURL();
      }
      const userDocData={username:authData.username,email:authData.email,birthday:authData.birthday,avatar:avatarUrl,friends:[],createdAt:new Date().toISOString()};
      await window.db.collection('users').doc(cred.user.uid).set(userDocData);
      setUserData({id:cred.user.uid,...userDocData});
    }catch(e){setAuthError(e.message);}
    setAuthLoading(false);
  };

  const handleLogin=async()=>{
    if(!authData.email||!authData.password)return;
    setAuthLoading(true);setAuthError('');
    try{await window.auth.signInWithEmailAndPassword(authData.email,authData.password);}
    catch(e){setAuthError(e.code==='auth/invalid-credential'?'Invalid email or password':e.message);}
    setAuthLoading(false);
  };

  const handleLogout=async()=>{
    await window.auth.signOut();
    setMyPosts([]);setFriends([]);setPosted(false);
    setAuthData({email:'',password:'',username:'',birthday:'',avatar:null});
  };

  const uploadImage=async(dataUrl,path)=>{
    const ref=window.storage.ref(path);
    await ref.putString(dataUrl,'data_url');
    return await ref.getDownloadURL();
  };

  const saveProfile=async()=>{
    if(!editUsername.trim()&&!editAvatar)return;
    setSavingProfile(true);
    try{
      const updates={};
      if(editUsername.trim())updates.username=editUsername;
      if(editAvatar)updates.avatar=await uploadImage(editAvatar,`avatars/${user.uid}`);
      await window.db.collection('users').doc(user.uid).update(updates);
      setUserData(d=>({...d,...updates}));
      setEditingProfile(false);
    }catch(e){console.error(e);}
    setSavingProfile(false);
  };

  const startEditProfile=()=>{setEditUsername(userData?.username||'');setEditAvatar(null);setEditingProfile(true);};
  const uploadAuth=(e)=>{const f=e.target.files?.[0];if(f){const r=new FileReader();r.onloadend=()=>setAuthData(p=>({...p,avatar:r.result}));r.readAsDataURL(f);}};
  const uploadEditAvatar=(e)=>{const f=e.target.files?.[0];if(f){const r=new FileReader();r.onloadend=()=>setEditAvatar(r.result);r.readAsDataURL(f);}};
  const upload=(e,k)=>{const f=e.target.files?.[0];if(f){const r=new FileReader();r.onloadend=()=>setNp(p=>({...p,[k]:r.result}));r.readAsDataURL(f);}};

  const submit=async()=>{
    if(!np.photo||!np.outfit||!np.songTitle||!np.songArtist||!np.loc)return;
    setUploading(true);
    try{
      const ts=Date.now();
      const photoUrl=await uploadImage(np.photo,`posts/${user.uid}/${ts}_photo`);
      const outfitUrl=await uploadImage(np.outfit,`posts/${user.uid}/${ts}_outfit`);
      const post={
        userId:user.uid,date:new Date().toISOString().split('T')[0],location:np.loc,
        photo:photoUrl,outfitPhoto:outfitUrl,
        photoX:np.photoX,photoY:np.photoY,outfitX:np.outfitX,outfitY:np.outfitY,
        song:{title:np.songTitle,artist:np.songArtist},
        songFont:np.songFont,songColor:np.songColor,
        quote:np.quote,privateNote:np.privateNote,
        createdAt:new Date().toISOString()
      };
      const docRef=await window.db.collection('posts').add(post);
      setMyPosts(x=>[{id:docRef.id,...post},...x]);
      setPosted(true);
      nav('feed');
      setStep(1);
      setNp({photo:null,outfit:null,songTitle:'',songArtist:'',loc:'',quote:'',privateNote:'',outfitX:0,outfitY:0,photoX:0,photoY:0,songFont:0,songColor:0});
    }catch(e){console.error(e);}
    setUploading(false);
  };

  const addFriendByCode=async()=>{
    if(!friendCode.trim())return;
    try{
      const snap=await window.db.collection('users').where('username','==',friendCode.trim()).get();
      if(!snap.empty){
        const friendDoc=snap.docs[0];
        const friendId=friendDoc.id;
        if(friendId===user.uid){setFriendCode('');return;}
        const userDoc=await window.db.collection('users').doc(user.uid).get();
        const currentFriends=userDoc.data()?.friends||[];
        if(!currentFriends.includes(friendId)){
          await window.db.collection('users').doc(user.uid).update({friends:[...currentFriends,friendId]});
          const friendData=await window.db.collection('users').doc(friendId).get();
          const friendFriends=friendData.data()?.friends||[];
          if(!friendFriends.includes(user.uid)){
            await window.db.collection('users').doc(friendId).update({friends:[...friendFriends,user.uid]});
          }
          await loadFriends(user.uid);
        }
      }else{alert('User not found');}
      setFriendCode('');
    }catch(e){console.error(e);}
  };

  const copyUsername=()=>{navigator.clipboard?.writeText(userData?.username||'');setLinkCopied(true);setTimeout(()=>setLinkCopied(false),2000);};

  // Save to camera roll - works on all devices
  const saveToCamera=async(post,owner)=>{
    setSaving(true);setShowMenu(false);
    try{
      // Create a temporary container for rendering
      const container=document.createElement('div');
      container.style.cssText='position:fixed;left:-9999px;top:0;width:600px;background:#fff;font-family:-apple-system,sans-serif;';
      document.body.appendChild(container);
      
      const font=FONTS[post.songFont||0]?.value||FONTS[0].value;
      const color=COLORS[post.songColor||0]||COLORS[0];
      
      container.innerHTML=`
        <div style="background:#fff;">
          <div style="position:relative;display:flex;height:360px;">
            <div style="flex:1;overflow:hidden;position:relative;">
              <img src="${post.outfitPhoto||post.outfit}" crossorigin="anonymous" style="width:100%;height:100%;object-fit:cover;object-position:${50+post.outfitX}% ${50+post.outfitY}%;"/>
              <div style="position:absolute;bottom:12px;left:12px;background:rgba(0,0,0,0.7);color:#fff;padding:6px 12px;border-radius:8px;font-size:14px;font-weight:600;">OOTD</div>
            </div>
            <div style="width:4px;background:#fff;"></div>
            <div style="flex:1;overflow:hidden;position:relative;">
              <img src="${post.photo}" crossorigin="anonymous" style="width:100%;height:100%;object-fit:cover;object-position:${50+post.photoX}% ${50+post.photoY}%;"/>
              <div style="position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,0.7);color:#fff;padding:6px 12px;border-radius:8px;font-size:14px;font-weight:600;">PHOTO</div>
            </div>
            <div style="position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);text-align:center;text-shadow:0 2px 8px rgba(0,0,0,0.95),0 0 20px rgba(0,0,0,0.5);padding:12px 20px;">
              <p style="margin:0;font-size:20px;font-weight:600;color:${color};font-family:${font};">ğŸµ ${post.song?.title||''}</p>
              <p style="margin:4px 0 0;font-size:15px;color:${color};font-family:${font};opacity:0.95;">${post.song?.artist||''}</p>
            </div>
            <div style="position:absolute;top:12px;left:50%;transform:translateX(-50%);background:#E07A5F;color:#fff;padding:6px 16px;border-radius:8px;font-size:12px;font-weight:700;">ğŸ“® POSTCARD</div>
          </div>
          <div style="padding:20px;border-top:2px solid #E8E4DF;">
            <div style="display:flex;align-items:center;gap:12px;">
              <div style="width:44px;height:44px;border-radius:14px;background:#E07A5F;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:600;color:#fff;overflow:hidden;">
                ${owner?.avatar?`<img src="${owner.avatar}" style="width:100%;height:100%;object-fit:cover;"/>`:(owner?.username?.[0]?.toUpperCase()||'?')}
              </div>
              <div>
                <p style="margin:0;font-size:17px;font-weight:600;color:#2D2A26;">${owner?.username||'You'}</p>
                <p style="margin:2px 0 0;font-size:13px;color:#8B8680;">ğŸ“ ${post.location||''} Â· ${post.date||new Date().toLocaleDateString()}</p>
              </div>
            </div>
            ${post.quote?`<p style="margin:14px 0 0;font-size:17px;font-style:italic;color:#2D2A26;">"${post.quote}"</p>`:''}
          </div>
        </div>
      `;
      
      // Wait for images to load
      const images=container.querySelectorAll('img');
      await Promise.all([...images].map(img=>new Promise(r=>{if(img.complete)r();else{img.onload=r;img.onerror=r;}})));
      
      const canvas=await html2canvas(container,{scale:2,useCORS:true,allowTaint:true,backgroundColor:'#ffffff'});
      document.body.removeChild(container);
      
      // Convert to blob and trigger download
      canvas.toBlob((blob)=>{
        const url=URL.createObjectURL(blob);
        const a=document.createElement('a');
        a.href=url;
        a.download=`postcard-${post.date||new Date().toISOString().split('T')[0]}.png`;
        a.click();
        URL.revokeObjectURL(url);
        setSaving(false);
      },'image/png',1.0);
    }catch(e){
      console.error('Save error:',e);
      alert('Could not save. Please try again.');
      setSaving(false);
    }
  };

  // Delete post
  const deletePost=async(postId)=>{
    if(!confirm('Delete this postcard? This cannot be undone.'))return;
    setShowMenu(false);
    try{
      await window.db.collection('posts').doc(postId).delete();
      setMyPosts(p=>p.filter(x=>x.id!==postId));
      const today=new Date().toISOString().split('T')[0];
      const remaining=myPosts.filter(x=>x.id!==postId);
      setPosted(remaining.some(p=>p.date===today));
      nav('feed');
    }catch(e){console.error(e);alert('Could not delete. Try again.');}
  };

  const allTodayPosts=()=>{
    const today=new Date().toISOString().split('T')[0];
    const fp=friends.flatMap(f=>f.posts?.filter(p=>p.date===today).map(p=>({...p,friend:f}))||[]);
    const mp=myPosts.filter(p=>p.date===today).map(p=>({...p,friend:{...userData,id:user?.uid}}));
    return[...mp,...fp];
  };
  
  const getBirthdays=(date)=>{
    const month=date.getMonth()+1;const day=date.getDate();
    const all=[...friends];if(userData&&userData.birthday)all.push(userData);
    return all.filter(f=>{if(!f.birthday)return false;const parts=f.birthday.split('-');return parseInt(parts[1],10)===month&&parseInt(parts[2],10)===day;});
  };
  
  const getMyPostForDate=(day)=>{
    const ds=`${calDate.getFullYear()}-${String(calDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    return myPosts.find(p=>p.date===ds);
  };
  const getFriendPostForDate=(friend,day,cd)=>{
    const ds=`${cd.getFullYear()}-${String(cd.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    return friend.posts?.find(p=>p.date===ds);
  };
  const days=d=>({n:new Date(d.getFullYear(),d.getMonth()+1,0).getDate(),s:new Date(d.getFullYear(),d.getMonth(),1).getDay()});
  const fmtM=d=>d.toLocaleDateString('en-US',{month:'long',year:'numeric'});
  const{n:daysN,s:startD}=days(calDate);
  const now=new Date();
  const isCur=calDate.getMonth()===now.getMonth()&&calDate.getFullYear()===now.getFullYear();

  // Postcard component
  const PostcardView=({post,owner,showPrivate=false,isOwner=false,showMenuOption=false})=>{
    const font=FONTS[post.songFont||0]?.value||FONTS[0].value;
    const color=COLORS[post.songColor||0]||COLORS[0];
    
    return(
      <div style={{position:'relative'}}>
        <div style={{background:t.card,borderRadius:16,border:`1px solid ${t.border}`,overflow:'hidden',boxShadow:'0 4px 12px rgba(0,0,0,0.08)'}}>
          <div style={{position:'relative',display:'flex',height:200}}>
            {/* Left - OOTD */}
            <div style={{flex:1,overflow:'hidden',position:'relative'}}>
              <img src={post.outfitPhoto||post.outfit} style={{width:'100%',height:'100%',objectFit:'cover',objectPosition:`${50+(post.outfitX||0)}% ${50+(post.outfitY||0)}%`}}/>
              <div style={{position:'absolute',bottom:8,left:8,background:'rgba(0,0,0,0.7)',color:'#fff',padding:'4px 10px',borderRadius:6,fontSize:11,fontWeight:600}}>OOTD</div>
            </div>
            <div style={{width:3,background:t.card}}/>
            {/* Right - Photo */}
            <div style={{flex:1,overflow:'hidden',position:'relative'}}>
              <img src={post.photo} style={{width:'100%',height:'100%',objectFit:'cover',objectPosition:`${50+(post.photoX||0)}% ${50+(post.photoY||0)}%`}}/>
              <div style={{position:'absolute',bottom:8,right:8,background:'rgba(0,0,0,0.7)',color:'#fff',padding:'4px 10px',borderRadius:6,fontSize:11,fontWeight:600}}>PHOTO</div>
            </div>
            {/* Song - centered */}
            <div style={{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-50%)',textAlign:'center',textShadow:'0 2px 8px rgba(0,0,0,0.95),0 0 20px rgba(0,0,0,0.5)',padding:'10px 16px'}}>
              <p style={{margin:0,fontSize:15,fontWeight:600,color,fontFamily:font}}>ğŸµ {post.song?.title}</p>
              <p style={{margin:'3px 0 0',fontSize:12,color,fontFamily:font,opacity:0.95}}>{post.song?.artist}</p>
            </div>
            <div style={{position:'absolute',top:10,left:'50%',transform:'translateX(-50%)',background:t.accent,color:'#fff',padding:'5px 12px',borderRadius:6,fontSize:10,fontWeight:700}}>ğŸ“® POSTCARD</div>
          </div>
          <div style={{padding:14,borderTop:`1px solid ${t.border}`}}>
            <div style={{display:'flex',alignItems:'center',gap:10}}>
              {owner?.avatar?<img src={owner.avatar} style={{width:32,height:32,borderRadius:10,objectFit:'cover'}}/>:<div style={{width:32,height:32,borderRadius:10,background:t.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:13,fontWeight:600,color:'#fff'}}>{owner?.username?.[0]?.toUpperCase()||'?'}</div>}
              <div style={{flex:1}}>
                <p style={{margin:0,fontSize:13,fontWeight:600,color:t.text}}>{owner?.id===user?.uid?'You':owner?.username||'User'}</p>
                <p style={{margin:0,fontSize:11,color:t.muted}}>ğŸ“ {post.location} Â· {post.date}</p>
              </div>
            </div>
            {post.quote&&<p style={{margin:'10px 0 0',fontSize:14,fontStyle:'italic',color:t.text}}>"{post.quote}"</p>}
            {showPrivate&&post.privateNote&&<div style={{marginTop:8,padding:8,background:dark?'#3d3520':'#fff8e1',borderRadius:6,border:`1px dashed ${dark?'#665c30':'#ffc107'}`}}><p style={{margin:0,fontSize:10,color:dark?'#ffc107':'#f57c00'}}>ğŸ”’ {post.privateNote}</p></div>}
          </div>
        </div>
        
        {/* 3-dot menu for owner */}
        {showMenuOption&&isOwner&&(
          <div style={{display:'flex',justifyContent:'center',marginTop:12}}>
            <div style={{position:'relative'}}>
              <span className="tap" onClick={()=>setShowMenu(!showMenu)} style={{display:'flex',gap:4,padding:'8px 16px',background:t.card,borderRadius:20,border:`1px solid ${t.border}`,alignItems:'center'}}>
                <span style={{width:5,height:5,borderRadius:'50%',background:t.muted}}/>
                <span style={{width:5,height:5,borderRadius:'50%',background:t.muted}}/>
                <span style={{width:5,height:5,borderRadius:'50%',background:t.muted}}/>
              </span>
              {showMenu&&(
                <>
                  <div onClick={()=>setShowMenu(false)} style={{position:'fixed',top:0,left:0,right:0,bottom:0,zIndex:99}}/>
                  <div style={{position:'absolute',bottom:'100%',left:'50%',transform:'translateX(-50%)',marginBottom:8,background:t.card,borderRadius:14,border:`1px solid ${t.border}`,boxShadow:'0 4px 20px rgba(0,0,0,0.15)',overflow:'hidden',zIndex:100,minWidth:200}}>
                    <span className="tap" onClick={()=>saveToCamera(post,owner)} style={{display:'flex',alignItems:'center',gap:12,padding:'14px 18px',color:t.text,fontSize:14,fontWeight:500,borderBottom:`1px solid ${t.border}`}}>
                      <span style={{fontSize:18}}>ğŸ’¾</span>Save to Photos
                    </span>
                    <span className="tap" onClick={()=>deletePost(post.id)} style={{display:'flex',alignItems:'center',gap:12,padding:'14px 18px',color:'#e53935',fontSize:14,fontWeight:500}}>
                      <span style={{fontSize:18}}>ğŸ—‘ï¸</span>Delete Post
                    </span>
                  </div>
                </>
              )}
            </div>
          </div>
        )}
      </div>
    );
  };

  // Editor preview
  const EditorPreview=()=>{
    const font=FONTS[np.songFont]?.value;
    const color=COLORS[np.songColor];
    return(
      <div style={{background:t.card,borderRadius:16,border:`1px solid ${t.border}`,overflow:'hidden',boxShadow:'0 4px 12px rgba(0,0,0,0.08)'}}>
        <div style={{position:'relative',display:'flex',height:200}}>
          <div onClick={()=>setActiveEdit('outfit')} style={{flex:1,overflow:'hidden',position:'relative',outline:activeEdit==='outfit'?`3px solid ${t.accent}`:'none',outlineOffset:'-3px',cursor:'pointer'}}>
            <img src={np.outfit} style={{width:'100%',height:'100%',objectFit:'cover',objectPosition:`${50+np.outfitX}% ${50+np.outfitY}%`}}/>
            <div style={{position:'absolute',bottom:8,left:8,background:'rgba(0,0,0,0.7)',color:'#fff',padding:'4px 10px',borderRadius:6,fontSize:11,fontWeight:600}}>OOTD</div>
          </div>
          <div style={{width:3,background:t.card}}/>
          <div onClick={()=>setActiveEdit('photo')} style={{flex:1,overflow:'hidden',position:'relative',outline:activeEdit==='photo'?`3px solid ${t.accent}`:'none',outlineOffset:'-3px',cursor:'pointer'}}>
            <img src={np.photo} style={{width:'100%',height:'100%',objectFit:'cover',objectPosition:`${50+np.photoX}% ${50+np.photoY}%`}}/>
            <div style={{position:'absolute',bottom:8,right:8,background:'rgba(0,0,0,0.7)',color:'#fff',padding:'4px 10px',borderRadius:6,fontSize:11,fontWeight:600}}>PHOTO</div>
          </div>
          <div onClick={()=>setActiveEdit('song')} style={{position:'absolute',left:'50%',top:'50%',transform:'translate(-50%,-50%)',textAlign:'center',textShadow:'0 2px 8px rgba(0,0,0,0.95),0 0 20px rgba(0,0,0,0.5)',padding:'10px 16px',borderRadius:8,background:activeEdit==='song'?'rgba(255,255,255,0.2)':'transparent',border:activeEdit==='song'?`2px dashed ${t.accent}`:'2px dashed transparent',cursor:'pointer'}}>
            <p style={{margin:0,fontSize:15,fontWeight:600,color,fontFamily:font}}>ğŸµ {np.songTitle||'Song'}</p>
            <p style={{margin:'3px 0 0',fontSize:12,color,fontFamily:font,opacity:0.95}}>{np.songArtist||'Artist'}</p>
          </div>
          <div style={{position:'absolute',top:10,left:'50%',transform:'translateX(-50%)',background:t.accent,color:'#fff',padding:'5px 12px',borderRadius:6,fontSize:10,fontWeight:700}}>ğŸ“® POSTCARD</div>
        </div>
        <div style={{padding:14,borderTop:`1px solid ${t.border}`}}>
          <div style={{display:'flex',alignItems:'center',gap:10}}>
            {userData?.avatar?<img src={userData.avatar} style={{width:32,height:32,borderRadius:10,objectFit:'cover'}}/>:<div style={{width:32,height:32,borderRadius:10,background:t.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:13,fontWeight:600,color:'#fff'}}>{userData?.username?.[0]?.toUpperCase()||'?'}</div>}
            <div style={{flex:1}}>
              <p style={{margin:0,fontSize:13,fontWeight:600,color:t.text}}>You</p>
              <p style={{margin:0,fontSize:11,color:t.muted}}>ğŸ“ {np.loc||'Location'} Â· Today</p>
            </div>
          </div>
          {np.quote&&<p style={{margin:'10px 0 0',fontSize:14,fontStyle:'italic',color:t.text}}>"{np.quote}"</p>}
        </div>
      </div>
    );
  };

  // Edit controls
  const EditControls=()=>{
    if(!activeEdit)return(
      <div style={{padding:20,background:t.card,borderRadius:16,border:`2px dashed ${t.border}`,textAlign:'center'}}>
        <p style={{margin:0,color:t.muted,fontSize:14}}>ğŸ‘† Tap an image or song text to edit</p>
      </div>
    );

    if(activeEdit==='song'){
      return(
        <div style={{background:t.card,borderRadius:16,padding:20,border:`2px solid ${t.accent}`}}>
          <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
            <p style={{margin:0,fontSize:16,fontWeight:600,color:t.text}}>ğŸµ Song Style</p>
            <span className="tap" onClick={()=>setActiveEdit(null)} style={{fontSize:20,color:t.muted,padding:4}}>âœ•</span>
          </div>
          <p style={{margin:'0 0 10px',fontSize:13,fontWeight:500,color:t.text}}>Font</p>
          <div style={{display:'flex',gap:8,flexWrap:'wrap',marginBottom:16}}>
            {FONTS.map((f,i)=>(
              <span key={i} className="tap" onClick={()=>setNp(p=>({...p,songFont:i}))} style={{padding:'10px 14px',borderRadius:10,fontSize:13,background:np.songFont===i?t.accent:t.bg,color:np.songFont===i?'#fff':t.text,fontFamily:f.value,fontWeight:500}}>{f.name}</span>
            ))}
          </div>
          <p style={{margin:'0 0 10px',fontSize:13,fontWeight:500,color:t.text}}>Color</p>
          <div style={{display:'flex',gap:10}}>
            {COLORS.map((c,i)=>(
              <span key={i} className="tap" onClick={()=>setNp(p=>({...p,songColor:i}))} style={{width:40,height:40,borderRadius:10,background:c,border:np.songColor===i?`3px solid ${t.accent}`:`2px solid ${t.border}`,boxShadow:'0 2px 4px rgba(0,0,0,0.1)'}}/>
            ))}
          </div>
        </div>
      );
    }

    const isOutfit=activeEdit==='outfit';
    const prefix=isOutfit?'outfit':'photo';

    return(
      <div style={{background:t.card,borderRadius:16,padding:20,border:`2px solid ${t.accent}`}}>
        <div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}>
          <p style={{margin:0,fontSize:16,fontWeight:600,color:t.text}}>{isOutfit?'ğŸ‘• Outfit':'ğŸ“· Photo'} Position</p>
          <span className="tap" onClick={()=>setActiveEdit(null)} style={{fontSize:20,color:t.muted,padding:4}}>âœ•</span>
        </div>
        <div style={{display:'grid',gridTemplateColumns:'repeat(3,1fr)',gap:10,maxWidth:200,margin:'0 auto'}}>
          <div/>
          <span className="tap" onClick={()=>setNp(p=>({...p,[`${prefix}Y`]:p[`${prefix}Y`]-10}))} style={{padding:18,background:t.bg,borderRadius:12,textAlign:'center',fontSize:22}}>â†‘</span>
          <div/>
          <span className="tap" onClick={()=>setNp(p=>({...p,[`${prefix}X`]:p[`${prefix}X`]-10}))} style={{padding:18,background:t.bg,borderRadius:12,textAlign:'center',fontSize:22}}>â†</span>
          <span className="tap" onClick={()=>setNp(p=>({...p,[`${prefix}X`]:0,[`${prefix}Y`]:0}))} style={{padding:18,background:t.accent,borderRadius:12,textAlign:'center',fontSize:11,fontWeight:600,color:'#fff',display:'flex',alignItems:'center',justifyContent:'center'}}>Reset</span>
          <span className="tap" onClick={()=>setNp(p=>({...p,[`${prefix}X`]:p[`${prefix}X`]+10}))} style={{padding:18,background:t.bg,borderRadius:12,textAlign:'center',fontSize:22}}>â†’</span>
          <div/>
          <span className="tap" onClick={()=>setNp(p=>({...p,[`${prefix}Y`]:p[`${prefix}Y`]+10}))} style={{padding:18,background:t.bg,borderRadius:12,textAlign:'center',fontSize:22}}>â†“</span>
          <div/>
        </div>
      </div>
    );
  };

  // Saving overlay
  const SavingOverlay=()=>saving?(
    <div style={{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.6)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:1000}}>
      <div style={{background:t.card,padding:28,borderRadius:20,textAlign:'center'}}>
        <div style={{fontSize:32,marginBottom:12}}>ğŸ’¾</div>
        <p style={{margin:0,fontSize:16,fontWeight:500,color:t.text}}>Saving to photos...</p>
      </div>
    </div>
  ):null;

  if(view==='loading')return(<div style={{display:'flex',alignItems:'center',justifyContent:'center',minHeight:'100vh',background:t.bg}}><div style={{textAlign:'center'}}><div style={{fontSize:48,marginBottom:12}}>ğŸ“®</div><p style={{color:t.muted,margin:0}}>Loading...</p></div></div>);

  if(view==='auth')return(
    <div style={{width:'100%',maxWidth:430,minHeight:'100vh',margin:'0 auto',fontFamily:'-apple-system,sans-serif',background:t.bg,padding:20,display:'flex',flexDirection:'column'}}>
      <SavingOverlay/>
      <div style={{flex:1,display:'flex',flexDirection:'column',justifyContent:'center'}}>
        <div style={{textAlign:'center',marginBottom:40}}><div style={{fontSize:60,marginBottom:8}}>ğŸ“®</div><h1 style={{margin:0,fontSize:32,fontWeight:700,color:t.text}}>postcard</h1><p style={{margin:'8px 0 0',color:t.muted}}>Share your day with friends</p></div>
        <div style={{display:'flex',marginBottom:24,background:t.card,borderRadius:12,padding:4,border:`1px solid ${t.border}`}}><span className="tap" onPointerDown={()=>{setAuthMode('login');setAuthError('');}} style={{flex:1,padding:12,borderRadius:8,textAlign:'center',fontSize:14,fontWeight:600,background:authMode==='login'?t.accent:'transparent',color:authMode==='login'?'#fff':t.muted}}>Log In</span><span className="tap" onPointerDown={()=>{setAuthMode('signup');setAuthError('');}} style={{flex:1,padding:12,borderRadius:8,textAlign:'center',fontSize:14,fontWeight:600,background:authMode==='signup'?t.accent:'transparent',color:authMode==='signup'?'#fff':t.muted}}>Sign Up</span></div>
        {authMode==='signup'&&<div style={{display:'flex',justifyContent:'center',marginBottom:20}}><input type="file" accept="image/*" onChange={uploadAuth} style={{display:'none'}} id="avatar"/><label htmlFor="avatar" className="tap">{authData.avatar?<img src={authData.avatar} style={{width:80,height:80,borderRadius:24,objectFit:'cover',border:`3px solid ${t.accent}`}}/>:<div style={{width:80,height:80,borderRadius:24,background:t.card,border:`2px dashed ${t.border}`,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:4}}><span style={{fontSize:24}}>ğŸ“·</span><span style={{fontSize:10,color:t.muted}}>Add photo</span></div>}</label></div>}
        {authError&&<div style={{padding:12,marginBottom:12,borderRadius:10,background:'#ffebee',color:'#c62828',fontSize:13,textAlign:'center'}}>{authError}</div>}
        <div style={{display:'flex',flexDirection:'column',gap:12}}>
          {authMode==='signup'&&<div style={{display:'flex',alignItems:'center',gap:10,padding:14,borderRadius:14,border:`1px solid ${t.border}`,background:t.card}}><span>ğŸ‘¤</span><input placeholder="Username" value={authData.username} onChange={e=>setAuthData(p=>({...p,username:e.target.value}))} style={{flex:1,background:'transparent',border:'none',fontSize:15,color:t.text,outline:'none'}}/></div>}
          <div style={{display:'flex',alignItems:'center',gap:10,padding:14,borderRadius:14,border:`1px solid ${t.border}`,background:t.card}}><span>âœ‰ï¸</span><input type="email" placeholder="Email" value={authData.email} onChange={e=>setAuthData(p=>({...p,email:e.target.value}))} style={{flex:1,background:'transparent',border:'none',fontSize:15,color:t.text,outline:'none'}}/></div>
          <div style={{display:'flex',alignItems:'center',gap:10,padding:14,borderRadius:14,border:`1px solid ${t.border}`,background:t.card}}><span>ğŸ”’</span><input type="password" placeholder="Password (6+ characters)" value={authData.password} onChange={e=>setAuthData(p=>({...p,password:e.target.value}))} style={{flex:1,background:'transparent',border:'none',fontSize:15,color:t.text,outline:'none'}}/></div>
          {authMode==='signup'&&<><div style={{display:'flex',alignItems:'center',gap:10,padding:14,borderRadius:14,border:`1px solid ${t.border}`,background:t.card}}><span>ğŸ‚</span><input type="date" value={authData.birthday} onChange={e=>setAuthData(p=>({...p,birthday:e.target.value}))} style={{flex:1,background:'transparent',border:'none',fontSize:15,color:t.text,outline:'none'}}/></div><p style={{margin:0,fontSize:11,color:t.muted,textAlign:'center'}}>Friends will see your birthday on their calendar</p></>}
        </div>
        <span className={`tap ${authLoading?'loading':''}`} onPointerDown={authMode==='login'?handleLogin:handleSignup} style={{marginTop:24,color:'#fff',padding:16,borderRadius:14,fontSize:16,fontWeight:600,textAlign:'center',background:t.accent}}>{authLoading?'Please wait...':authMode==='login'?'Log In':'Create Account'}</span>
      </div>
    </div>
  );

  return(
    <div style={{width:'100%',maxWidth:430,minHeight:'100vh',margin:'0 auto',fontFamily:'-apple-system,sans-serif',background:t.bg}}>
      <style>{`@keyframes up{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}@keyframes float{0%,100%{transform:translateY(0) rotate(-2deg)}50%{transform:translateY(-5px) rotate(2deg)}}`}</style>
      <SavingOverlay/>

      {view==='feed'&&<div ref={scrollRef} style={{minHeight:'100vh',paddingBottom:100,overflowY:'auto'}}>
        <header style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 20px'}}><div style={{display:'flex',alignItems:'center',gap:8}}><span style={{fontSize:26,fontWeight:700,color:t.text}}>postcard</span><span style={{fontSize:18,animation:'float 3s infinite'}}>âœˆï¸</span></div><div style={{display:'flex',gap:8}}><span className="tap" onPointerDown={()=>nav('settings')} style={{fontSize:20,padding:8,color:t.muted}}>âš™ï¸</span><span className="tap" onPointerDown={()=>nav('profile')} style={{padding:8}}>{userData?.avatar?<img src={userData.avatar} style={{width:36,height:36,borderRadius:12,objectFit:'cover'}}/>:<div style={{width:36,height:36,borderRadius:12,background:t.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,fontWeight:600,color:'#fff'}}>{userData?.username?.[0]?.toUpperCase()||'?'}</div>}</span></div></header>
        {!posted&&<div style={{margin:'0 20px 20px',padding:24,borderRadius:20,textAlign:'center',border:`2px dashed ${t.border}`,background:t.card}}><div style={{fontSize:40,marginBottom:8}}>ğŸ“®</div><p style={{color:t.text,margin:'0 0 14px',fontSize:15}}>Share your day to see friends' postcards</p><span className="tap" onPointerDown={()=>nav('post')} style={{display:'inline-block',color:'#fff',padding:'14px 28px',borderRadius:14,fontSize:15,fontWeight:600,background:t.accent}}>Send postcard âœ‰ï¸</span></div>}
        {allTodayPosts().length===0&&posted&&<div style={{padding:'40px 20px',textAlign:'center'}}><p style={{color:t.muted,fontSize:15}}>No postcards from friends today yet.</p></div>}
        <div style={{padding:'0 20px',display:'flex',flexDirection:'column',gap:16}}>{allTodayPosts().map((p,i)=>(<div key={p.id} className="tap" onPointerDown={()=>(setSel(p),setView('detail'))} style={{animation:`up .4s ${i*.1}s both`}}><PostcardView post={p} owner={p.friend} showPrivate={p.userId===user?.uid}/></div>))}</div>
        <nav style={{position:'fixed',bottom:0,left:'50%',transform:'translateX(-50%)',width:'100%',maxWidth:430,padding:scrolled?'8px 20px 20px':'16px 20px 34px',display:'flex',justifyContent:'space-around',alignItems:'center',background:`linear-gradient(transparent,${t.bg})`,transition:'padding .3s'}}><span style={{fontSize:scrolled?18:24,padding:scrolled?8:12}}>ğŸ </span><span className="tap" onPointerDown={()=>nav('post')} style={{width:scrolled?40:56,height:scrolled?40:56,borderRadius:scrolled?12:16,display:'flex',alignItems:'center',justifyContent:'center',fontSize:scrolled?20:28,color:'#fff',background:t.accent,transition:'all .3s'}}>+</span><span className="tap" onPointerDown={()=>nav('profile')} style={{fontSize:scrolled?18:24,padding:scrolled?8:12,opacity:.5}}>ğŸ‘¤</span></nav>
      </div>}

      {view==='settings'&&<div style={{minHeight:'100vh',background:t.bg,padding:'0 20px'}}><header style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 0'}}><span className="tap" onPointerDown={()=>nav('feed')} style={{fontSize:28,padding:'8px 12px',color:t.text}}>â†</span><span style={{fontWeight:600,color:t.text}}>Settings</span><div style={{width:48}}/></header><div style={{display:'flex',flexDirection:'column',gap:12}}><div style={{padding:16,borderRadius:16,border:`1px solid ${t.border}`,background:t.card}}><p style={{margin:'0 0 12px',fontWeight:600,color:t.text}}>Edit Profile</p>{!editingProfile?<div style={{display:'flex',alignItems:'center',gap:12}}>{userData?.avatar?<img src={userData.avatar} style={{width:50,height:50,borderRadius:16,objectFit:'cover'}}/>:<div style={{width:50,height:50,borderRadius:16,background:t.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:18,fontWeight:600,color:'#fff'}}>{userData?.username?.[0]?.toUpperCase()||'?'}</div>}<div style={{flex:1}}><p style={{margin:0,fontWeight:600,color:t.text}}>{userData?.username}</p><p style={{margin:'2px 0 0',fontSize:13,color:t.muted}}>{userData?.email}</p></div><span className="tap" onPointerDown={startEditProfile} style={{padding:'8px 16px',borderRadius:8,background:t.accent,color:'#fff',fontSize:13,fontWeight:600}}>Edit</span></div>:<div style={{display:'flex',flexDirection:'column',gap:12}}><div style={{display:'flex',justifyContent:'center'}}><input type="file" accept="image/*" onChange={uploadEditAvatar} style={{display:'none'}} id="editAvatar"/><label htmlFor="editAvatar" className="tap">{(editAvatar||userData?.avatar)?<img src={editAvatar||userData?.avatar} style={{width:70,height:70,borderRadius:20,objectFit:'cover',border:`3px solid ${t.accent}`}}/>:<div style={{width:70,height:70,borderRadius:20,background:t.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:24,fontWeight:600,color:'#fff'}}>{userData?.username?.[0]?.toUpperCase()||'?'}</div>}</label></div><p style={{margin:0,fontSize:11,color:t.muted,textAlign:'center'}}>Tap to change photo</p><div style={{display:'flex',alignItems:'center',gap:10,padding:12,borderRadius:10,border:`1px solid ${t.border}`,background:t.bg}}><span>ğŸ‘¤</span><input placeholder="Username" value={editUsername} onChange={e=>setEditUsername(e.target.value)} style={{flex:1,background:'transparent',border:'none',fontSize:14,color:t.text,outline:'none'}}/></div><div style={{display:'flex',gap:8}}><span className="tap" onPointerDown={()=>setEditingProfile(false)} style={{flex:1,padding:12,borderRadius:8,border:`1px solid ${t.border}`,textAlign:'center',fontSize:14,color:t.text}}>Cancel</span><span className={`tap ${savingProfile?'loading':''}`} onPointerDown={saveProfile} style={{flex:1,padding:12,borderRadius:8,background:t.accent,textAlign:'center',fontSize:14,color:'#fff',fontWeight:600}}>{savingProfile?'Saving...':'Save'}</span></div></div>}</div><div style={{display:'flex',alignItems:'center',justifyContent:'space-between',padding:16,borderRadius:16,border:`1px solid ${t.border}`,background:t.card}}><div style={{display:'flex',alignItems:'center',gap:12}}><span style={{fontSize:24}}>{dark?'ğŸŒ™':'â˜€ï¸'}</span><div><p style={{margin:0,fontWeight:600,color:t.text}}>{dark?'Dark':'Light'} mode</p></div></div><span className="tap" onPointerDown={()=>setDark(!dark)} style={{width:50,height:30,borderRadius:15,padding:3,background:dark?t.accent:t.border,display:'block'}}><div style={{width:24,height:24,borderRadius:12,background:'#fff',transform:dark?'translateX(20px)':'translateX(0)',transition:'transform .3s'}}/></span></div><span className="tap" onPointerDown={handleLogout} style={{padding:16,borderRadius:16,border:`1px solid ${t.border}`,background:t.card,textAlign:'center',color:'#e53935',fontWeight:600}}>Log Out</span></div></div>}

      {view==='profile'&&<div style={{minHeight:'100vh',background:t.bg,padding:'0 20px 40px'}}><header style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 0'}}><span className="tap" onPointerDown={()=>nav('feed')} style={{fontSize:28,padding:'8px 12px',color:t.text}}>â†</span><span style={{fontWeight:600,color:t.text}}>Profile</span><div style={{width:48}}/></header><div style={{display:'flex',flexDirection:'column',alignItems:'center',paddingTop:10}}>{userData?.avatar?<img src={userData.avatar} style={{width:80,height:80,borderRadius:24,objectFit:'cover',marginBottom:12}}/>:<div style={{width:80,height:80,borderRadius:24,background:t.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,fontWeight:700,color:'#fff',marginBottom:12}}>{userData?.username?.[0]?.toUpperCase()||'?'}</div>}<h2 style={{margin:'0 0 4px',fontSize:22,fontWeight:600,color:t.text}}>{userData?.username||'User'}</h2>{userData?.birthday&&<p style={{margin:'0 0 16px',fontSize:12,color:t.muted}}>ğŸ‚ {new Date(userData.birthday+'T00:00:00').toLocaleDateString('en-US',{month:'long',day:'numeric'})}</p>}<div style={{display:'flex',gap:24,padding:20,borderRadius:16,border:`1px solid ${t.border}`,width:'100%',background:t.card,marginBottom:20}}><div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:4}}><span style={{fontSize:24,fontWeight:700,color:t.text}}>{myPosts.length}</span><span style={{fontSize:13,color:t.muted}}>Postcards</span></div><div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:4}}><span style={{fontSize:24,fontWeight:700,color:t.text}}>{friends.length}</span><span style={{fontSize:13,color:t.muted}}>Friends</span></div></div><div style={{width:'100%',marginBottom:20}}><span className="tap" onPointerDown={()=>setShowAddFriend(!showAddFriend)} style={{display:'flex',alignItems:'center',justifyContent:'center',gap:8,padding:14,borderRadius:14,background:t.accent,color:'#fff',fontWeight:600,fontSize:14}}>{showAddFriend?'âœ• Close':'ğŸ‘¥ Add Friends'}</span>{showAddFriend&&<div style={{marginTop:12,padding:16,borderRadius:16,border:`1px solid ${t.border}`,background:t.card}}><p style={{margin:'0 0 8px',fontSize:13,fontWeight:600,color:t.text}}>Add by username:</p><div style={{display:'flex',gap:8}}><input placeholder="Username" value={friendCode} onChange={e=>setFriendCode(e.target.value)} style={{flex:1,padding:12,borderRadius:10,border:`1px solid ${t.border}`,background:t.bg,fontSize:14,color:t.text,outline:'none'}}/><span className="tap" onPointerDown={addFriendByCode} style={{padding:'12px 16px',borderRadius:10,background:t.accent,color:'#fff',fontSize:14,fontWeight:600}}>Add</span></div><div style={{borderTop:`1px solid ${t.border}`,marginTop:16,paddingTop:16}}><p style={{margin:'0 0 8px',fontSize:13,color:t.muted}}>Your username:</p><span className="tap" onPointerDown={copyUsername} style={{display:'block',padding:14,borderRadius:10,background:t.bg,textAlign:'center',fontSize:14,color:t.accent,fontWeight:600}}>{linkCopied?'âœ“ Copied!':userData?.username}</span></div></div>}</div>{friends.length>0&&<div style={{width:'100%',marginBottom:20}}><p style={{margin:'0 0 12px',fontSize:14,fontWeight:600,color:t.text}}>Friends</p><div style={{display:'flex',flexDirection:'column',gap:8}}>{friends.map(f=><div key={f.id} className="tap" onPointerDown={()=>{setFriendProfile(f);setFriendCalDate(new Date());setView('friendProfile');}} style={{display:'flex',alignItems:'center',gap:10,padding:12,borderRadius:12,border:`1px solid ${t.border}`,background:t.card}}>{f.avatar?<img src={f.avatar} style={{width:40,height:40,borderRadius:12,objectFit:'cover'}}/>:<div style={{width:40,height:40,borderRadius:12,background:t.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:14,fontWeight:600,color:'#fff'}}>{f.username?.[0]?.toUpperCase()}</div>}<div style={{flex:1}}><p style={{margin:0,fontSize:14,fontWeight:600,color:t.text}}>{f.username}</p></div><span style={{fontSize:18,color:t.muted}}>â†’</span></div>)}</div></div>}<div style={{width:'100%',borderRadius:16,border:`1px solid ${t.border}`,padding:16,background:t.card}}><p style={{margin:'0 0 12px',fontSize:14,fontWeight:600,color:t.text}}>Your Postcards</p><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}><span className="tap" onPointerDown={()=>setCalDate(new Date(calDate.getFullYear(),calDate.getMonth()-1,1))} style={{fontSize:24,padding:'4px 12px',color:t.text}}>â€¹</span><span style={{fontWeight:600,color:t.text}}>{fmtM(calDate)}</span><span className="tap" onPointerDown={()=>setCalDate(new Date(calDate.getFullYear(),calDate.getMonth()+1,1))} style={{fontSize:24,padding:'4px 12px',color:t.text}}>â€º</span></div><div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',marginBottom:8}}>{['S','M','T','W','T','F','S'].map((d,i)=><div key={i} style={{textAlign:'center',fontSize:12,fontWeight:600,padding:8,color:t.muted}}>{d}</div>)}</div><div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:4}}>{Array(startD).fill(null).map((_,i)=><div key={`e${i}`}/>)}{Array(daysN).fill(null).map((_,i)=>{const day=i+1;const pfd=getMyPostForDate(day);const isT=isCur&&day===now.getDate();const bdays=getBirthdays(new Date(calDate.getFullYear(),calDate.getMonth(),day));return<div key={day} className={pfd?"tap":""} onPointerDown={()=>pfd&&(setDayPost(pfd),setView('dayDetail'))} style={{aspectRatio:'1',display:'flex',alignItems:'center',justifyContent:'center',borderRadius:10,background:pfd?t.accent:bdays.length?'#fff3e0':'transparent',color:pfd?'#fff':t.text,border:isT?`2px solid ${t.accent}`:'none',fontWeight:isT?700:400,flexDirection:'column',position:'relative'}}>{pfd?<><span style={{fontSize:10}}>{day}</span><span style={{fontSize:8}}>ğŸ“®</span></>:<span style={{fontSize:12}}>{day}</span>}{bdays.length>0&&!pfd&&<span style={{position:'absolute',bottom:2,fontSize:8}}>ğŸ‚</span>}</div>})}</div></div></div></div>}

      {view==='friendProfile'&&friendProfile&&<div style={{minHeight:'100vh',background:t.bg,padding:'0 20px 40px'}}><header style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 0'}}><span className="tap" onPointerDown={()=>nav('profile')} style={{fontSize:28,padding:'8px 12px',color:t.text}}>â†</span><span style={{fontWeight:600,color:t.text}}>{friendProfile.username}</span><div style={{width:48}}/></header><div style={{display:'flex',flexDirection:'column',alignItems:'center',paddingTop:10}}>{friendProfile.avatar?<img src={friendProfile.avatar} style={{width:80,height:80,borderRadius:24,objectFit:'cover',marginBottom:12}}/>:<div style={{width:80,height:80,borderRadius:24,background:t.accent,display:'flex',alignItems:'center',justifyContent:'center',fontSize:28,fontWeight:700,color:'#fff',marginBottom:12}}>{friendProfile.username?.[0]?.toUpperCase()}</div>}<h2 style={{margin:'0 0 4px',fontSize:22,fontWeight:600,color:t.text}}>{friendProfile.username}</h2>{friendProfile.birthday&&<p style={{margin:'0 0 16px',fontSize:12,color:t.muted}}>ğŸ‚ {new Date(friendProfile.birthday+'T00:00:00').toLocaleDateString('en-US',{month:'long',day:'numeric'})}</p>}<div style={{display:'flex',gap:24,padding:20,borderRadius:16,border:`1px solid ${t.border}`,width:'100%',background:t.card,marginBottom:20}}><div style={{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:4}}><span style={{fontSize:24,fontWeight:700,color:t.text}}>{friendProfile.posts?.length||0}</span><span style={{fontSize:13,color:t.muted}}>Postcards</span></div></div><div style={{width:'100%',borderRadius:16,border:`1px solid ${t.border}`,padding:16,background:t.card}}><p style={{margin:'0 0 12px',fontSize:14,fontWeight:600,color:t.text}}>{friendProfile.username}'s Postcards</p><div style={{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:16}}><span className="tap" onPointerDown={()=>setFriendCalDate(new Date(friendCalDate.getFullYear(),friendCalDate.getMonth()-1,1))} style={{fontSize:24,padding:'4px 12px',color:t.text}}>â€¹</span><span style={{fontWeight:600,color:t.text}}>{fmtM(friendCalDate)}</span><span className="tap" onPointerDown={()=>setFriendCalDate(new Date(friendCalDate.getFullYear(),friendCalDate.getMonth()+1,1))} style={{fontSize:24,padding:'4px 12px',color:t.text}}>â€º</span></div><div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',marginBottom:8}}>{['S','M','T','W','T','F','S'].map((d,i)=><div key={i} style={{textAlign:'center',fontSize:12,fontWeight:600,padding:8,color:t.muted}}>{d}</div>)}</div><div style={{display:'grid',gridTemplateColumns:'repeat(7,1fr)',gap:4}}>{Array(days(friendCalDate).s).fill(null).map((_,i)=><div key={`e${i}`}/>)}{Array(days(friendCalDate).n).fill(null).map((_,i)=>{const day=i+1;const pfd=getFriendPostForDate(friendProfile,day,friendCalDate);const isT=friendCalDate.getMonth()===now.getMonth()&&friendCalDate.getFullYear()===now.getFullYear()&&day===now.getDate();return<div key={day} className={pfd?"tap":""} onPointerDown={()=>pfd&&(setFriendDayPost({...pfd,friend:friendProfile}),setView('friendDayDetail'))} style={{aspectRatio:'1',display:'flex',alignItems:'center',justifyContent:'center',borderRadius:10,background:pfd?t.accent:'transparent',color:pfd?'#fff':t.text,border:isT?`2px solid ${t.accent}`:'none',fontWeight:isT?700:400,flexDirection:'column'}}>{pfd?<><span style={{fontSize:10}}>{day}</span><span style={{fontSize:8}}>ğŸ“®</span></>:<span style={{fontSize:12}}>{day}</span>}</div>})}</div></div></div></div>}

      {view==='post'&&<div style={{minHeight:'100vh',padding:'0 20px 40px',background:t.bg}}>
        <header style={{display:'flex',justifyContent:'space-between',alignItems:'center',padding:'16px 0'}}><span className="tap" onPointerDown={()=>step>1?setStep(step-1):nav('feed')} style={{fontSize:28,padding:'8px 12px',color:t.text}}>â†</span><span style={{fontWeight:600,color:t.text}}>{step===1?'ğŸ“¸ Photos':step===2?'ğŸµ Details':step===3?'âœï¸ Edit':'âœ“ Preview'}</span><span style={{color:t.muted,padding:'8px 12px'}}>{step}/4</span></header>
        
        {step===1&&<div style={{display:'flex',flexDirection:'column',gap:16}}>
          <p style={{color:t.muted,textAlign:'center',margin:0,fontSize:14}}>Outfit (left) & Photo (right)</p>
          <div style={{display:'grid',gridTemplateColumns:'1fr 1fr',gap:12}}>
            {['outfit','photo'].map((k,i)=><div key={k} style={{aspectRatio:'3/4',borderRadius:16,overflow:'hidden',border:`2px dashed ${t.border}`,background:t.card}}><input type="file" accept="image/*" onChange={e=>upload(e,k)} style={{display:'none'}} id={k}/><label htmlFor={k} style={{width:'100%',height:'100%',display:'flex',cursor:'pointer'}}>{np[k]?<img src={np[k]} style={{width:'100%',height:'100%',objectFit:'cover'}}/>:<div style={{width:'100%',height:'100%',display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',gap:8}}><span style={{fontSize:40}}>{i===0?'ğŸ‘•':'ğŸ“·'}</span><span style={{color:t.muted,fontSize:14}}>{i===0?'Outfit':'Photo'}</span></div>}</label></div>)}
          </div>
          <span className="tap" onPointerDown={()=>np.photo&&np.outfit&&setStep(2)} style={{color:'#fff',padding:18,borderRadius:14,fontSize:16,fontWeight:600,textAlign:'center',background:t.accent,opacity:np.photo&&np.outfit?1:.4}}>Next â†’</span>
        </div>}
        
        {step===2&&<div style={{display:'flex',flexDirection:'column',gap:14}}>
          {[{icon:'ğŸµ',key:'songTitle',placeholder:'Song title'},{icon:'ğŸ¤',key:'songArtist',placeholder:'Artist'},{icon:'ğŸ“',key:'loc',placeholder:'Location'},{icon:'ğŸ’¬',key:'quote',placeholder:'Quote (optional)'},{icon:'ğŸ”’',key:'privateNote',placeholder:'Private note',bg:'#fff8e1'}].map(f=>(
            <div key={f.key} style={{display:'flex',alignItems:'center',gap:12,padding:16,borderRadius:14,border:`1px solid ${t.border}`,background:f.bg||t.card}}>
              <span style={{fontSize:18}}>{f.icon}</span>
              <input placeholder={f.placeholder} value={np[f.key]} onChange={e=>setNp(p=>({...p,[f.key]:e.target.value}))} style={{flex:1,background:'transparent',border:'none',fontSize:16,color:t.text,outline:'none'}}/>
            </div>
          ))}
          <div style={{display:'flex',gap:12,marginTop:8}}>
            <span className="tap" onPointerDown={()=>setStep(1)} style={{padding:'16px 24px',border:`1px solid ${t.border}`,borderRadius:14,fontSize:15,color:t.text,background:t.card}}>â†</span>
            <span className="tap" onPointerDown={()=>np.songTitle&&np.songArtist&&np.loc&&setStep(3)} style={{flex:1,color:'#fff',padding:18,borderRadius:14,fontSize:16,fontWeight:600,textAlign:'center',background:t.accent,opacity:np.songTitle&&np.songArtist&&np.loc?1:.4}}>Next â†’</span>
          </div>
        </div>}
        
        {step===3&&<div style={{display:'flex',flexDirection:'column',gap:20}}>
          <EditorPreview/>
          <EditControls/>
          <div style={{display:'flex',gap:12}}>
            <span className="tap" onPointerDown={()=>setStep(2)} style={{padding:'16px 24px',border:`1px solid ${t.border}`,borderRadius:14,fontSize:15,color:t.text,background:t.card}}>â†</span>
            <span className="tap" onPointerDown={()=>{setActiveEdit(null);setStep(4);}} style={{flex:1,color:'#fff',padding:18,borderRadius:14,fontSize:16,fontWeight:600,textAlign:'center',background:t.accent}}>Preview â†’</span>
          </div>
        </div>}
        
        {step===4&&<div style={{display:'flex',flexDirection:'column',gap:20}}>
          <p style={{color:t.text,textAlign:'center',margin:0,fontSize:16,fontWeight:500}}>Ready to send? ğŸ‰</p>
          <PostcardView post={{...np,song:{title:np.songTitle,artist:np.songArtist},location:np.loc,outfitPhoto:np.outfit,date:'Today'}} owner={userData} showPrivate={true}/>
          <div style={{display:'flex',gap:12}}>
            <span className="tap" onPointerDown={()=>setStep(3)} style={{padding:'16px 24px',border:`1px solid ${t.border}`,borderRadius:14,fontSize:15,color:t.text,background:t.card}}>â† Edit</span>
            <span className={`tap ${uploading?'loading':''}`} onPointerDown={submit} style={{flex:1,color:'#fff',padding:18,borderRadius:14,fontSize:16,fontWeight:600,textAlign:'center',background:t.accent}}>{uploading?'Sending...':'Send âœˆï¸'}</span>
          </div>
        </div>}
      </div>}

      {view==='detail'&&sel&&<div style={{minHeight:'100vh',background:t.bg,padding:16}}><span className="tap" onPointerDown={()=>nav('feed')} style={{position:'absolute',top:16,right:16,width:36,height:36,borderRadius:12,fontSize:16,display:'flex',alignItems:'center',justifyContent:'center',background:t.card,color:t.text,zIndex:10}}>âœ•</span><div style={{paddingTop:40}}><PostcardView post={sel} owner={sel.friend} showPrivate={sel.userId===user?.uid} isOwner={sel.userId===user?.uid} showMenuOption={true}/></div></div>}
      
      {view==='dayDetail'&&dayPost&&<div style={{minHeight:'100vh',background:t.bg,padding:16}}><span className="tap" onPointerDown={()=>{setView('profile');setDayPost(null);setShowMenu(false);}} style={{position:'absolute',top:16,right:16,width:36,height:36,borderRadius:12,fontSize:16,display:'flex',alignItems:'center',justifyContent:'center',background:t.card,color:t.text,zIndex:10}}>âœ•</span><div style={{paddingTop:40}}><PostcardView post={dayPost} owner={{...userData,id:user?.uid}} showPrivate={true} isOwner={true} showMenuOption={true}/></div></div>}
      
      {view==='friendDayDetail'&&friendDayPost&&<div style={{minHeight:'100vh',background:t.bg,padding:16}}><span className="tap" onPointerDown={()=>{setView('friendProfile');setFriendDayPost(null);}} style={{position:'absolute',top:16,right:16,width:36,height:36,borderRadius:12,fontSize:16,display:'flex',alignItems:'center',justifyContent:'center',background:t.card,color:t.text,zIndex:10}}>âœ•</span><div style={{paddingTop:40}}><PostcardView post={friendDayPost} owner={friendDayPost.friend} showPrivate={false}/></div></div>}
    </div>
  );
}
ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
</script>
</body>
</html>
